<script src="~/js/moment.min.js" type="text/javascript"></script>
<script>
    //Variáveis
    participante_default = {
        op_part_id: 0,
        op_part_nome: '',
        op_part_tipo: '',
        op_part_cnpj_cpf: '',
        op_part_cep: '',
        op_part_cidade: '',
        op_part_bairro: '',
        op_part_logradouro: '',
        op_part_numero: '',
        op_part_complemento: '',
        op_paisesIBGE_codigo: 0,
        op_uf_ibge_codigo: 0,
        op_part_participante_id: 0,
        existe: false,
        controleEdit: '',
    };

    retencoes_default = {
        op_ret_id: '',
        op_ret_pis: '',
        op_ret_cofins: '',
        op_ret_csll: '',
        op_ret_irrf: '',
        op_ret_inss: '',
        op_ret_issqn: '',
        existe: false,
    };

    transportador_default = {
        op_transportador_id: 0,
        op_transportador_nome: '',
        op_transportador_cnpj_cpf: '',
        op_transportador_modalidade_frete: '',
        op_transportador_volume_qtd: 0,
        op_transportador_volume_peso_bruto: 0,
        op_transportador_participante_id: 0,
        existe: false,
    };

    nf_default = {
        op_nf_id: 0,
        op_nf_op_id: 0,
        op_nf_chave: '',
        op_nf_data_emissao: '',
        op_nf_data_entrada_saida: '',
        op_nf_serie: '',
        op_nf_numero: '',
        existe: false,
    };

    servico_default = {
        op_servico_id: 0,
        op_servico_op_id: 0,
        op_servico_equipamento: '',
        op_servico_nSerie: '',
        op_servico_problema: '',
        op_servico_obsReceb: '',
        op_servico_servico_executado: '',
        op_servico_valor: '',
        op_servico_status: '',
        op_servico_lc116: '',
    };

    parcela = {
        op_parcela_id: 0,
        op_parcela_dias: 0,
        op_parcela_vencimento: '',
        op_parcela_fp_id: 0,
        op_parcela_op_id: 0,
        op_parcela_valor: '',
        op_parcela_obs: '',
        op_parcela_saldo: '',
        op_parcela_ret_inss: '',
        op_parcela_ret_issqn: '',
        op_parcela_ret_irrf: '',
        op_parcela_ret_pis: '',
        op_parcela_ret_cofins: '',
        op_parcela_ret_csll: '',
        op_parcela_valor_bruto: '',
        op_parcela_agrupamento: 0,
        op_parcela_vencimento_alterado: '',
        op_parcela_numero: 0,
        op_parcela_numero_total: 0,
        op_parcela_label_forma_pgto: '',
        baixas: 0,
    };

    //Funcções
    function change_op_tipo(id, vlr, contexto) {
        let s = convertStringDouble(operacao.servico.op_servico_valor);
        let p = operacao.itens.length;
        let o = convertStringDouble(document.getElementById('op_totais_valor_outras_operacoes').value);

        if (s > 0 || p > 0 || o > 0) {
            let up = '<button type="button" class="btn btn-danger" onclick="change_op_tipo(\'' + id + '\', \'' + vlr + '\',\'confirmado\')">Alterar</button>';
            let del = '<button type="button" class="btn btn-secondary" onclick="change_op_tipo(\'' + id + '\', \'' + vlr + '\',\'nao_confirmado\')">Cancelar</button>';

            if (contexto == 'confirmar') {
                if (document.getElementById('footer_update_especie')) {
                    document.getElementById('footer_update_especie').innerHTML = '';
                    $('#footer_update_especie').append(up);
                    $('#footer_update_especie').append(del);
                }
                //Abre modal
                modal_sobre_modal_open('modal_update_especie');
            }

            if (contexto == 'nao_confirmado') {
                if (document.getElementById('footer_update_especie')) {
                    document.getElementById('footer_update_especie').innerHTML = '';
                    $('#footer_update_especie').append(up);
                    $('#footer_update_especie').append(del);
                }

                document.getElementById('op_tipo').value = operacao.operacao.op_tipo;

                $('#modal_update_especie').modal('hide');
            }
        } else {
            contexto = 'confirmado';
        }

        if (contexto == 'confirmado') {

            $('#modal_update_especie').modal('hide');

            if (vlr == 'Compra' || vlr == 'Venda') { //Compra/Venda Produtos
                document.getElementById('itens_operacao').style.display = 'block';
                document.getElementById('servico_operacao').style.display = 'none';
                document.getElementById('outros_operacao').style.display = 'none';

                document.getElementById('totais_servico').style.display = 'none';
                document.getElementById('totais_itens').style.display = 'block';
                document.getElementById('totais_demais').style.display = 'none';
            }
            if (vlr == 'ServicoPrestado' || vlr == 'ServicoTomado') { //Serviços
                document.getElementById('itens_operacao').style.display = 'none';
                document.getElementById('servico_operacao').style.display = 'block';
                document.getElementById('outros_operacao').style.display = 'none';

                document.getElementById('totais_servico').style.display = 'block';
                document.getElementById('totais_itens').style.display = 'none';
                document.getElementById('totais_demais').style.display = 'none';
            }
            if (vlr == 'OutrasDespesas' || vlr == 'OutrasReceitas') {//Outros
                document.getElementById('itens_operacao').style.display = 'none';
                document.getElementById('servico_operacao').style.display = 'none';
                document.getElementById('outros_operacao').style.display = 'block';

                document.getElementById('totais_servico').style.display = 'none';
                document.getElementById('totais_itens').style.display = 'none';
                document.getElementById('totais_demais').style.display = 'block';
            }
            operacao.operacao.op_tipo = vlr;

            //Limpa operação
            limparOperacao();

            //Produzindo selects categoria e forma de pagamento contextualizada ao tipo op.
            GerarFormaPgto(vlr, 'op_parcela_fp_id');            
            GerarFormaPgto(vlr, 'op_parcela_fp_id_edit');            

            GerarCategorias(vlr, 'op_categoria_id');
            $("#op_categoria_id").select2({
                placeholder: "Selecione uma categoria...",
                allowClear: true
            });
        }
    }

    function limparOperacao() {
        //Outras operações
        retornaOutrasOperacoesZero();
        //Remove os itens da operação
        excluirTodosItensOperacao();
        //Retorna serviços a defoult
        retornaServicoDefault();
        //Limpa retenções
        document.getElementById('op_ret_inss').value = '';
        document.getElementById('op_ret_issqn').value = '';
        document.getElementById('op_ret_irrf').value = '';
        document.getElementById('op_ret_pis').value = '';
        document.getElementById('op_ret_cofins').value = '';
        document.getElementById('op_ret_csll').value = '';
        document.getElementById('retencoes').value = 'Não informado';
        operacao.retencoes.op_ret_inss = convertDoubleString(0);
        operacao.retencoes.op_ret_issqn = convertDoubleString(0);
        operacao.retencoes.op_ret_irrf = convertDoubleString(0);
        operacao.retencoes.op_ret_pis = convertDoubleString(0);
        operacao.retencoes.op_ret_cofins = convertDoubleString(0);
        operacao.retencoes.op_ret_csll = convertDoubleString(0);
        //Limpaa parcelas
        operacao.parcelas.splice(0, operacao.parcelas.length);
        document.getElementById('parcelas').value = 'Não informado';
        //Limpando totais
        document.getElementById('op_totais_preco_itens').value = convertDoubleString(0);
        document.getElementById('op_totais_frete').value = convertDoubleString(0);
        document.getElementById('op_totais_seguro').value = convertDoubleString(0);
        document.getElementById('op_totais_desp_aces').value = convertDoubleString(0);
        document.getElementById('op_totais_desconto').value = convertDoubleString(0);
        document.getElementById('op_totais_icms_st').value = convertDoubleString(0);
        document.getElementById('op_totais_ipi').value = convertDoubleString(0);
        document.getElementById('op_totais_preco_servicos').value = convertDoubleString(0);
        document.getElementById('op_totais_valor_outras_operacoes_totais').value = convertDoubleString(0);
        document.getElementById('op_totais_total_op').value = convertDoubleString(0);
        operacao.totais.op_totais_preco_itens = convertDoubleString(0);
        operacao.totais.op_totais_frete = convertDoubleString(0);
        operacao.totais.op_totais_seguro = convertDoubleString(0);
        operacao.totais.op_totais_desp_aces = convertDoubleString(0);
        operacao.totais.op_totais_desconto = convertDoubleString(0);
        operacao.totais.op_totais_icms_st = convertDoubleString(0);
        operacao.totais.op_totais_ipi = convertDoubleString(0);
        operacao.totais.op_totais_preco_servicos = convertDoubleString(0);
        operacao.totais.op_totais_valor_outras_operacoes_totais = convertDoubleString(0);
        operacao.totais.op_totais_total_op = convertDoubleString(0);
        //Limpando documento fiscal
        document.getElementById('op_nf_data_emissao').value = '';
        document.getElementById('op_nf_serie').value = '';
        document.getElementById('op_nf_numero').value = '';
        document.getElementById('op_nf_chave').value = '';
        document.getElementById('documento').value = 'Não informado';
        operacao.nf.op_nf_data_emissao = '';
        operacao.nf.op_nf_numero = '';
        operacao.nf.op_nf_serie = '';
        operacao.nf.op_nf_chave = '';        
        operacao.nf.op_comNF = 0;        
        operacao.nf.op_nf_tipo = 0;
        //Limpando operação.operação
        operacao.operacao.op_comRetencoes = false;
        operacao.operacao.possui_parcelas = false;
    }

    function retornaOutrasOperacoesZero() {
        document.getElementById('op_totais_valor_outras_operacoes').value = convertDoubleString(0);
        document.getElementById('op_totais_total_op').value = convertDoubleString(0);
        document.getElementById('totais').value = convertDoubleString(0);
        document.getElementById('op_totais_valor_outras_operacoes_totais').value = convertDoubleString(0);
        operacao.totais.op_totais_total_op = convertDoubleString(0);
        operacao.totais.op_totais_valor_outras_operacoes = convertDoubleString(0);
    }

    function excluirTodosItensOperacao() { //Exclui todos os itens da matriz de itens de operação.itens.
        operacao.itens.splice(0, operacao.itens.length);
        document.getElementById('itens').value = 'Não informado';

        operacao.totais.op_totais_itens = 0;
        operacao.totais.op_totais_qtd_itens = '';

        totaisOperacao();
    }

    function retornaServicoDefault() {
        operacao.servico.op_servico_valor = 0;
        operacao.servico.op_servico_servico_executado = '';
        operacao.servico.op_servico_lc116 = '';
        document.getElementById('op_servico_valor').value = 0,00;
        document.getElementById('op_servico_servico_executado').value = '';
        document.getElementById('op_servico_lc116').value = '';
        
        document.getElementById('servicos').value = 'Não informado';

        totaisOperacao();
    }

    function gravar_servico_operacao() {
        operacao.servico.op_servico_servico_executado = document.getElementById('op_servico_servico_executado').value;
        operacao.servico.op_servico_lc116 = document.getElementById('op_servico_lc116').value;
        operacao.servico.op_servico_valor = document.getElementById('op_servico_valor').value.toLocaleString("pt-BR", { style: "decimal", minimumFractionDigits: "2", maximumFractionDigits: "2" });

        document.getElementById('servicos').value = 'LC 116/2003: ' + operacao.servico.op_servico_lc116 + ' | Valor: ' + operacao.servico.op_servico_valor;

        totaisOperacao();

        $('#m_servico').modal('hide');
    }

    function gravarDadosParticipante(contexto, op_part_participante_id) {
        dadorParticipante(contexto, op_part_participante_id);

        if (document.getElementById('participante')) {
            document.getElementById('participante').value = operacao.participante.op_part_nome;
        }

        if (document.getElementById('modal_participante')) {
            $('#modal_participante').modal('hide');
        }
    }

    function operacao_participante(contexto) {
        if (contexto == 'open_input') {
            //Limpar objeto participante
            operacao.participante.controleEdit = '';
            operacao.participante.existe = false;
            operacao.participante.op_paisesIBGE_codigo = '1058';
            operacao.participante.op_part_bairro = '';
            operacao.participante.op_part_cep = '';
            operacao.participante.op_part_cidade = '';
            operacao.participante.op_part_cnpj_cpf = '';
            operacao.participante.op_part_complemento = '';
            operacao.participante.op_part_id = 0;
            operacao.participante.op_part_logradouro = '';
            operacao.participante.op_part_nome = '';
            operacao.participante.op_part_numero = '';
            operacao.participante.op_part_participante_id = 0;
            operacao.participante.op_part_tipo = '1';
            operacao.participante.op_uf_ibge_codigo = '35';
            
            //Limpar os campos
            document.getElementById('nome').value = '';
            document.getElementById('participante_tipoPessoa').value = 1;
            document.getElementById('op_part_cnpj_cpf').value = '';
            document.getElementById('cep').value = '';
            document.getElementById('rua').value = '';
            document.getElementById('numero').value = '';
            document.getElementById('complemento').value = '';
            document.getElementById('bairro').value = '';
            document.getElementById('cidade').value = '';
            document.getElementById('uf').value = 35;
            document.getElementById('op_paisesIBGE_codigo').value = 1058;
            document.getElementById('participante_tipoPessoa').value = 1;

            //gravando informação que operação é sem participante
            operacao.operacao.op_comParticipante = false;

            //abrir para edição
            document.getElementById('participante').value = '';
            document.getElementById('participante').disabled = false;
            document.getElementById('participante').focus();
        }



        if (contexto == 'open') {
            if (document.getElementById('nome')) {
                document.getElementById('nome').value = operacao.participante.op_part_nome;                
            }
            if (document.getElementById('participante_tipoPessoa')) {
                document.getElementById('participante_tipoPessoa').value = operacao.participante.op_part_tipo;
            }
            if (document.getElementById('op_part_cnpj_cpf')) {
                document.getElementById('op_part_cnpj_cpf').value = operacao.participante.op_part_cnpj_cpf;
            }
            if (document.getElementById('cep')) {
                document.getElementById('cep').value = operacao.participante.op_part_cep;
            }
            if (document.getElementById('rua')) {
                document.getElementById('rua').value = operacao.participante.op_part_logradouro;
            }
            if (document.getElementById('numero')) {
                document.getElementById('numero').value = operacao.participante.op_part_numero;
            }
            if (document.getElementById('complemento')) {
                document.getElementById('complemento').value = operacao.participante.op_part_complemento;
            }
            if (document.getElementById('bairro')) {
                document.getElementById('bairro').value = operacao.participante.op_part_bairro;
            }
            if (document.getElementById('cidade')) {
                document.getElementById('cidade').value = operacao.participante.op_part_cidade;
            }
            if (document.getElementById('uf')) {
                document.getElementById('uf').value = operacao.participante.op_uf_ibge_codigo;
            }
            if (document.getElementById('op_paisesIBGE_codigo')) {
                document.getElementById('op_paisesIBGE_codigo').value = operacao.participante.op_paisesIBGE_codigo;
            }           

            //Abre modal
            modal_sobre_modal_open('modal_participante'); 

            document.getElementById('nome').focus();
        }

        if (contexto == 'save') {

            if (operacao.op_part_participante_id != 0) {
                if (document.getElementById('nome')) {
                    operacao.participante.op_part_nome = document.getElementById('nome').value;
                }
                if (document.getElementById('participante_tipoPessoa')) {
                    operacao.participante.op_part_tipo = document.getElementById('participante_tipoPessoa').value;
                }
                if (document.getElementById('op_part_cnpj_cpf')) {
                    operacao.participante.op_part_cnpj_cpf = document.getElementById('op_part_cnpj_cpf').value;
                }
                if (document.getElementById('cep')) {
                    operacao.participante.op_part_cep = document.getElementById('cep').value;
                }
                if (document.getElementById('rua')) {
                    operacao.participante.op_part_logradouro = document.getElementById('rua').value;
                }
                if (document.getElementById('numero')) {
                    operacao.participante.op_part_numero = document.getElementById('numero').value;
                }
                if (document.getElementById('complemento')) {
                    operacao.participante.op_part_complemento = document.getElementById('complemento').value;
                }
                if (document.getElementById('bairro')) {
                    operacao.participante.op_part_bairro = document.getElementById('bairro').value;
                }
                if (document.getElementById('cidade')) {
                    operacao.participante.op_part_cidade = document.getElementById('cidade').value;
                }
                if (document.getElementById('uf')) {
                    operacao.participante.op_uf_ibge_codigo = document.getElementById('uf').value;
                }
                if (document.getElementById('op_paisesIBGE_codigo')) {
                    operacao.participante.op_paisesIBGE_codigo = document.getElementById('op_paisesIBGE_codigo').value;
                }

                //gravando informação que operação é com participante
                operacao.operacao.op_comParticipante = true;

                document.getElementById('participante').value = operacao.participante.op_part_nome;
                if (document.getElementById('modal_participante')) {
                    $('#modal_participante').modal('hide');
                }

                if (document.getElementById('op_categoria_id')) {
                    document.getElementById('op_categoria_id').focus();
                }
            }
        }

        if (contexto == 'delete') {
            //Limpadno objeto
            operacao.participante.controleEdit = '';
            operacao.participante.existe = false;
            operacao.participante.op_paisesIBGE_codigo = '1058';
            operacao.participante.op_part_bairro = '';
            operacao.participante.op_part_cep = '';
            operacao.participante.op_part_cidade = '';
            operacao.participante.op_part_cnpj_cpf = '';
            operacao.participante.op_part_complemento = '';
            operacao.participante.op_part_id = 0;
            operacao.participante.op_part_logradouro = '';
            operacao.participante.op_part_nome = '';
            operacao.participante.op_part_numero = '';
            operacao.participante.op_part_participante_id = 0;
            operacao.participante.op_part_tipo = '';
            operacao.participante.op_uf_ibge_codigo = 0;

            document.getElementById('participante').value = 'Não informado';
            //Limpa campos do modal
            document.getElementById('nome').value = '';
            document.getElementById('participante_tipoPessoa').value = 1;
            document.getElementById('op_part_cnpj_cpf').value = '';
            document.getElementById('cep').value = '';
            document.getElementById('rua').value = '';
            document.getElementById('numero').value = '';
            document.getElementById('complemento').value = '';
            document.getElementById('bairro').value = '';
            document.getElementById('cidade').value = '';
            document.getElementById('uf').value = 35;
            document.getElementById('op_paisesIBGE_codigo').value = 1058;

            //gravando informação que operação é sem participante
            operacao.operacao.op_comParticipante = false;

            //Fechando modal
            if (document.getElementById('modal_participante')) {
                $('#modal_participante').modal('hide');
            }
        }
    }

    function changeUFParticipante(id, vlr, contexto) {
        if (contexto == 'uf') {
            if (vlr == 0) {                          
                document.getElementById('op_paisesIBGE_codigo').removeAttribute("readonly");
            } else {                
                document.getElementById('op_paisesIBGE_codigo').setAttribute("readonly", "readonly");
                document.getElementById('op_paisesIBGE_codigo').value = '1058';
            }
        }
        if (contexto == 'pais') {
            let uf = document.getElementById('uf').value;
            if (uf != 0) {
                document.getElementById('op_paisesIBGE_codigo').value = '1058';
            }
        }
    }

    
    function operacao_itens(contexto) {
        if (contexto == 'open') {            
            //Atualiza tabela de itens
            atualizaViewItens();

            //Abrir modal
            modal_sobre_modal_open('lista_itens');

            if (document.getElementById('prod_descricao')) {
                document.getElementById('prod_descricao').focus();
            }   
        }

        if (contexto == 'close') {
            if (operacao.itens.length > 0) {
                document.getElementById('itens').value = 'Quantidade de Itens Informado: ' + operacao.itens.length;
            } else {
                document.getElementById('itens').value = 'Não informado';
            }

            if (document.getElementById('btn_retencoes')) {
                document.getElementById('btn_retencoes').focus();
            }
            
        }

        if (contexto == 'save') {
            let id = document.getElementById('produto_id').value;
            let prod_descricao = document.getElementById('prod_descricao').value;
            let prod_codigo = document.getElementById('prod_codigo').value;
            let prod_valor = document.getElementById('prod_valor').value;
            let prod_quantidade = document.getElementById('prod_quantidade').value;
            let prod_valorTotal = document.getElementById('prod_valorTotal').value;
            let prod_unidade = document.getElementById('unidade').value;

            if (id > 0) {
                document.getElementById('produto_id').value = 0;
                document.getElementById('prod_descricao').value = "";
                document.getElementById('prod_codigo').value = "";
                document.getElementById('prod_valor').value = "";
                document.getElementById('prod_quantidade').value = "";
                document.getElementById('prod_valorTotal').value = "";

                let numero_controle = id + Math.floor(Math.random() * 100000) + 1;

                if (isNaN((prod_valor.toString().replace('.', '').replace(',', '.') * 1)) || isNaN((prod_quantidade.toString().replace('.', '').replace(',', '.') * 1)) || isNaN((prod_valorTotal.toString().replace('.', '').replace(',', '.') * 1))) {
                    alert('Valor incorreto no valor unitário, quantidade ou total do item');
                    document.getElementById('prod_descricao').focus();
                } else {
                    let item_produto = {
                        op_item_numero_controle: numero_controle, //id é o produto_id selecionado. Adicionaod ao objeto para fins de controle (localiza-lo no momento da edição dos dados);
                        op_item_produto_id: id,
                        op_item_id: numero_controle,
                        op_item_codigo: prod_codigo,
                        op_item_nome: prod_descricao,
                        op_item_unidade: prod_unidade,
                        op_item_preco: prod_valor,
                        op_item_gtin_ean: '',
                        op_item_gtin_ean_trib: '',
                        op_item_obs: '',
                        op_item_qtd: prod_quantidade,
                        op_item_frete: '0,00',
                        op_item_seguros: '0,00',
                        op_item_desp_aces: '0,00',
                        op_item_desconto: '0,00',
                        op_item_vlr_ipi: '0,00',
                        op_item_vlr_icms_st: '0,00',
                        op_item_cod_fornecedor: '',
                        op_item_valor_total: prod_valorTotal,
                        controleEdit: 'insert',
                        op_item_id_banco: 0,
                    };
                    operacao.itens.push(item_produto);
                                        
                    //Atualiza tabela de itens
                    atualizaViewItens();                    

                    //Inserindo em totais total de itens
                    operacao.totais.op_totais_itens += 1;

                    //Inserindo em totais a soma das quantidades totais
                    let qtd_total = (operacao.totais.op_totais_qtd_itens.toString().replace('.', '').replace(',', '.') * 1) + (prod_quantidade.toString().replace('.', '').replace(',', '.') * 1);
                    operacao.totais.op_totais_qtd_itens = qtd_total.toLocaleString("pt-BR", { style: "decimal", minimumFractionDigits: "2", maximumFractionDigits: "6" });

                    document.getElementById('prod_descricao').focus();

                    //totaisOperacao();
                }

            } else {
                document.getElementById('prod_descricao').focus();
            }
        }

        totaisOperacao();
    }

    function operacao_item(contexto, op_item_numero_controle) {

        let item = operacao.itens.find(item => item.op_item_numero_controle == op_item_numero_controle);       

        if (contexto == 'edit') {   
            document.getElementById('op_item_numero_controle_edicao_item').value = item.op_item_numero_controle;
            document.getElementById('op_item_nome').value = item.op_item_nome;
            document.getElementById('op_item_codigo').value = item.op_item_codigo;
            document.getElementById('op_item_cod_fornecedor').value = item.op_item_cod_fornecedor;
            document.getElementById('op_item_unidade').value = item.op_item_unidade;
            decimal('op_item_preco', item.op_item_preco.toString().replace('.', ''), '6', true);
            decimal('op_item_qtd', item.op_item_qtd.toString().replace('.', ''), '6', true);
            decimal('item_valor_total', item.op_item_valor_total.toString().replace('.', ''), '6', true);
            decimal('op_item_frete', item.op_item_frete.toString().replace('.', ''), '6', true);
            decimal('op_item_seguros', item.op_item_seguros.toString().replace('.', ''), '6', true);
            decimal('op_item_desp_aces', item.op_item_desp_aces.toString().replace('.', ''), '6', true);
            decimal('op_item_desconto', item.op_item_desconto.toString().replace('.', ''), '6', true);
            decimal('op_item_vlr_ipi', item.op_item_vlr_ipi.toString().replace('.', ''), '6', true);
            decimal('op_item_vlr_icms_st', item.op_item_vlr_icms_st.toString().replace('.', ''), '6', true);

            //Abrir modal
            modal_sobre_modal_open('modal_item');
        }

        if (contexto == 'delete_confirmar') {
            document.getElementById('item_excluir').innerHTML = 'Confirma a exclusão do item: ' + item.op_item_nome + '?';
            document.getElementById('item_delete').value = item.op_item_numero_controle;
            //Abrir modal
            modal_sobre_modal_open('modal_item_delete');
        }

        if (contexto == 'delete_confirmado') {
            let codigo = document.getElementById('item_delete').value;            

            for (let i = 0; i < operacao.itens.length; i++) {
                if (operacao.itens[i].op_item_numero_controle == codigo) {
                    if (operacao.itens[i].controleEdit == 'update') {
                        //altera o status de controleEdit para enviar ao servidor para excluir no banco;
                        operacao.itens[i].controleEdit = 'delete';
                    } else {
                        //remove item do objeto operacao da matriz itens
                        operacao.itens.splice(i, 1);
                    }
                }
            }

            //Atualiza tabela de itens
            atualizaViewItens();

            //Fecha modal de confirmação
            $('#modal_item_delete').modal('hide');
        }

        if (contexto == 'save') {
            let op_item_numero_controle = document.getElementById('op_item_numero_controle_edicao_item').value * 1;

            for (let i = 0; i < operacao.itens.length; i++) {
                if (operacao.itens[i].op_item_numero_controle == op_item_numero_controle) {
                    //atualiza objeto
                    operacao.itens[i].op_item_codigo = document.getElementById('op_item_codigo').value;
                    operacao.itens[i].op_item_nome = document.getElementById('op_item_nome').value;
                    operacao.itens[i].op_item_unidade = document.getElementById('op_item_unidade').value;
                    operacao.itens[i].op_item_preco = document.getElementById('op_item_preco').value;
                    operacao.itens[i].op_item_qtd = document.getElementById('op_item_qtd').value;
                    operacao.itens[i].op_item_frete = document.getElementById('op_item_frete').value;
                    operacao.itens[i].op_item_seguros = document.getElementById('op_item_seguros').value;
                    operacao.itens[i].op_item_desp_aces = document.getElementById('op_item_desp_aces').value;
                    operacao.itens[i].op_item_desconto = document.getElementById('op_item_desconto').value;
                    operacao.itens[i].op_item_vlr_ipi = document.getElementById('op_item_vlr_ipi').value;
                    operacao.itens[i].op_item_vlr_icms_st = document.getElementById('op_item_vlr_icms_st').value;
                    operacao.itens[i].op_item_cod_fornecedor = document.getElementById('op_item_cod_fornecedor').value;
                    operacao.itens[i].op_item_valor_total = document.getElementById('item_valor_total').value;
                    //Atualiza tabela de itens
                    atualizaViewItens();
                    //calcula os totais
                    //totaisOperacao();
                    break;
                }
            }
            $('#modal_item').modal('hide');
        }

        totaisOperacao();
    }

    function atualizaViewItens() {
        for (let item = 0; item < operacao.itens.length; item++) {
            operacao.itens[item].op_item_numero_controle = item + 1;
        }

        document.getElementById('tbody_itens').innerHTML = '';

        for (let i = 0; i < operacao.itens.length; i++) {
            if (operacao.itens[i].controleEdit != 'delete') {
                item = '';
                item += '<tr>';
                item += '<td>';
                item += '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16" style="cursor:pointer;" onclick="operacao_item(\'edit\',\'' + operacao.itens[i].op_item_numero_controle + '\')">';
                item += '<path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456l-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z" />';
                item += '<path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z" />';
                item += '</svg>';
                item += '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16" style="cursor:pointer;" onclick="operacao_item(\'delete_confirmar\',\'' + operacao.itens[i].op_item_numero_controle + '\')">';
                item += '<path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z" />';
                item += '<path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4L4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z" />';
                item += '</svg>';
                item += '</td>';
                item += '<td>' + operacao.itens[i].op_item_nome + '</td>';
                item += '<td>' + operacao.itens[i].op_item_codigo + '</td>';
                item += '<td>' + operacao.itens[i].op_item_qtd + '</td>';
                item += '<td>' + operacao.itens[i].op_item_preco + '</td>';
                item += '<td>' + operacao.itens[i].op_item_valor_total + '</td>';
                item += '<td>' + 'NCM' + '</td>';
                item += '<td>' + 'CEST' + '</td>';
                item += '</tr>';
                $('#tbody_itens').append(item);
            }
        }
    }

    function operacao_servico(contexto) {
        if (contexto == 'open') {
            document.getElementById('op_servico_servico_executado').value = operacao.servico.op_servico_servico_executado;
            document.getElementById('op_servico_valor').value = operacao.servico.op_servico_valor.toLocaleString("pt-BR", { style: "decimal", minimumFractionDigits: "2", maximumFractionDigits: "6" });
            document.getElementById('op_servico_lc116').value = operacao.servico.op_servico_lc116;

            document.getElementById('op_servico_servico_executado').focus();

            //Abrir modal
            modal_sobre_modal_open('m_servico');
        }

        if (contexto == 'save') {

            let vlr = document.getElementById('op_servico_valor').value.toString().replace('.', '').replace(',', '.') * 1;

            if (vlr == 0) {
                document.getElementById('servicos').value = 'Não informado';
                document.getElementById('servico_val').innerHTML = 'Informe um valor para o serviço!';
            }

            if (vlr > 0) {
                document.getElementById('servico_val').innerHTML = '';

                operacao.servico.op_servico_servico_executado = document.getElementById('op_servico_servico_executado').value;
                operacao.servico.op_servico_valor = document.getElementById('op_servico_valor').value.toLocaleString("pt-BR", { style: "decimal", minimumFractionDigits: "2", maximumFractionDigits: "6" });
                operacao.servico.op_servico_lc116 = document.getElementById('op_servico_lc116').value;

                document.getElementById('servicos').value = 'Valor do Serviço Informado: ' + operacao.servico.op_servico_valor.toLocaleString("pt-BR", { style: "decimal", minimumFractionDigits: "2", maximumFractionDigits: "6" });

                //Fecha modal
                $('#m_servico').modal('hide');

                if (document.getElementById('btn_retencoes')) {
                    document.getElementById('btn_retencoes').focus();
                }
            }            
        }

        if (contexto == 'delete') {
            retornaServicoDefault();
            document.getElementById('servicos').value = 'Não informado';

            if (document.getElementById('btn_retencoes')) {
                document.getElementById('btn_retencoes').focus();
            }

            //Fecha modal
            $('#m_servico').modal('hide');
        }

        totaisOperacao();
    }

    function operacao_retencoes(contexto) {
        if (contexto == 'open') {
            decimal('op_ret_inss', operacao.retencoes.op_ret_inss, '2', false);
            decimal('op_ret_irrf', operacao.retencoes.op_ret_irrf, '2', false);
            decimal('op_ret_issqn', operacao.retencoes.op_ret_issqn, '2', false);
            decimal('op_ret_pis', operacao.retencoes.op_ret_pis, '2', false);
            decimal('op_ret_cofins', operacao.retencoes.op_ret_cofins, '2', false);
            decimal('op_ret_csll', operacao.retencoes.op_ret_csll, '2', false);

            document.getElementById('op_ret_inss').focus();

            //Abrir modal
            modal_sobre_modal_open('m_retencoes');
        }
        if (contexto == 'save') {
            operacao.retencoes.op_ret_inss = document.getElementById('op_ret_inss').value;
            operacao.retencoes.op_ret_issqn = document.getElementById('op_ret_issqn').value;
            operacao.retencoes.op_ret_irrf = document.getElementById('op_ret_irrf').value;

            let txt = '';
            let soma = 0;

            if (convertStringDouble(operacao.retencoes.op_ret_inss) > 0) {
                txt += 'INSS: ' + operacao.retencoes.op_ret_inss + ' ';
                soma += convertStringDouble(operacao.retencoes.op_ret_inss);
            }
            if (convertStringDouble(operacao.retencoes.op_ret_issqn) > 0) {
                txt += 'ISSQN: ' + operacao.retencoes.op_ret_issqn + ' ';
                soma += convertStringDouble(operacao.retencoes.op_ret_issqn);
            }
            if (convertStringDouble(operacao.retencoes.op_ret_irrf) > 0) {
                txt += 'IRRF: ' + operacao.retencoes.op_ret_irrf + ' ';
                soma += convertStringDouble(operacao.retencoes.op_ret_irrf);
            }
            if (convertStringDouble(operacao.retencoes.op_ret_pis) > 0) {
                txt += 'PIS: ' + operacao.retencoes.op_ret_pis + ' ';
                soma += convertStringDouble(operacao.retencoes.op_ret_pis);
            }
            if (convertStringDouble(operacao.retencoes.op_ret_cofins) > 0) {
                txt += 'COFINS: ' + operacao.retencoes.op_ret_cofins + ' ';
                soma += convertStringDouble(operacao.retencoes.op_ret_cofins);
            }
            if (convertStringDouble(operacao.retencoes.op_ret_csll) > 0) {
                txt += 'CSLL: ' + operacao.retencoes.op_ret_csll + ' ';
                soma += convertStringDouble(operacao.retencoes.op_ret_csll);
            }

            if (soma > 0) {
                document.getElementById('retencoes').value = txt;
            } else {
                document.getElementById('retencoes').value = 'Não informado';
            }

            //Atualiza parcelas para refazer informações da view
            atualizaViewParcelas();

            //Fecha modal
            $('#m_retencoes').modal('hide');

            if (document.getElementById('btn_parcelas')) {
                document.getElementById('btn_parcelas').focus();
            }
        }

        if (contexto == 'delete') {
            //Limpando objeto
            operacao.retencoes.op_ret_inss = convertDoubleString(0);
            operacao.retencoes.op_ret_issqn = convertDoubleString(0);
            operacao.retencoes.op_ret_irrf = convertDoubleString(0);
            operacao.retencoes.op_ret_pis = convertDoubleString(0);
            operacao.retencoes.op_ret_cofins = convertDoubleString(0);
            operacao.retencoes.op_ret_csll = convertDoubleString(0);

            //Limpando Campos
            decimal('op_ret_inss', 0, '2', false);
            decimal('op_ret_irrf', 0, '2', false);
            decimal('op_ret_issqn', 0, '2', false);
            decimal('op_ret_pis', 0, '2', false);
            decimal('op_ret_cofins', 0, '2', false);
            decimal('op_ret_csll', 0, '2', false);

            if (document.getElementById('btn_parcelas')) {
                document.getElementById('btn_parcelas').focus();
            }
        }

    }

    function operacao_totais(contexto) {
        if (contexto == 'open') {
            //Abrir modal
            modal_sobre_modal_open('m_totais');
        }
    }

    function GerarFormaPgto(op_tipo, select_id) {
        $.ajax({
            url: "/Operacao/GerarFormaPgto",
            data: { __RequestVerificationToken: gettoken(), op_tipo: op_tipo },
            type: 'POST',
            dataType: 'json',
            beforeSend: function (XMLHttpRequest) {
                /*if (document.getElementById('text_formaPgto')) {
                    document.getElementById('text_formaPgto').innerHTML = "Gerando lista de formas de pagamento";
                    if (document.getElementById('sub')) {
                        document.getElementById('sub').setAttribute("disabled", "disabled");
                    }
                }*/
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("erro");
            },
            success: function (data, textStatus, XMLHttpRequest) {
                var results = JSON.parse(data);
                $('#' + select_id).children('option').remove(); //Remove todos os itens do select

                for (i = 0; i < results.length; i++) { //Adiciona os item recebidos no results no select
                    $('#' + select_id).append($("<option></option>").attr("value", results[i].value).text(results[i].text));
                }

                /*if (document.getElementById('text_formaPgto')) {
                    document.getElementById('text_formaPgto').innerHTML = "";
                    if (document.getElementById('sub')) {
                        document.getElementById('sub').removeAttribute("disabled");
                    }
                }*/
            }
        });
    }

    function formaGerarParcelas(id, vlr) {
        if (vlr == 1) {
            document.getElementById('diaVencimento').style.display = 'block';
            document.getElementById('dataIncio_Fim').style.display = 'none';
            document.getElementById('numeroParcelas').style.display = 'none';
        }

        if (vlr == 2) {
            document.getElementById('diaVencimento').style.display = 'none';
            document.getElementById('dataIncio_Fim').style.display = 'block';
            document.getElementById('numeroParcelas').style.display = 'none';
        }

        if (vlr == 3) {
            document.getElementById('diaVencimento').style.display = 'none';
            document.getElementById('dataIncio_Fim').style.display = 'none';
            document.getElementById('numeroParcelas').style.display = 'block';
        }
    }

    function changeNumeroParcelas(id, vlr) {
        let i = parseInt(vlr.toString(), 10);
        i = i.toString().replace('-', '').replace('+', '').replace('.', '').replace(',', '');
        document.getElementById(id).value = i;
    }

    function atualizaViewParcelas() {
        document.getElementById('tbody_parcelas').innerHTML = '';

        let valor_liquido = 0;

        let s = document.getElementById('op_parcela_fp_id');

        for (let i = 0; i < operacao.parcelas.length; i++) {
            let label_fp = '';
            for (let x = 0; x < s.length; x++) {
                if (s.options[x].value == operacao.parcelas[i].op_parcela_fp_id) {
                    label_fp = s.options[x].text;
                    break;
                }                
            }

            item = '';
            item += '<tr>';
            item += '<td>';
            item += '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16" style="cursor:pointer;" onclick="operacao_parcelas(\'edit_open\',\'' + operacao.parcelas[i].op_parcela_numero + '\')">';
            item += '<path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456l-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z" />';
            item += '<path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z" />';
            item += '</svg>';
            item += '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16" style="cursor:pointer;" onclick="operacao_parcelas(\'delete_confirmar\',\'' + operacao.parcelas[i].op_parcela_numero + '\')">';
            item += '<path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z" />';
            item += '<path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4L4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z" />';
            item += '</svg>';
            item += '</td>';
            item += '<td>' + operacao.parcelas[i].op_parcela_vencimento + '</td>';
            item += '<td>' + operacao.parcelas[i].op_parcela_valor_bruto + '</td>';
            item += '<td>' + operacao.parcelas[i].op_parcela_valor + '</td>';
            item += '<td style="white-space:nowrap">' + label_fp + '</td>';
            item += '<td>' + operacao.parcelas[i].op_parcela_ret_irrf + '</td>';
            item += '<td>' + operacao.parcelas[i].op_parcela_ret_inss + '</td>';
            item += '<td>' + operacao.parcelas[i].op_parcela_ret_issqn + '</td>';
            item += '<td>' + operacao.parcelas[i].op_parcela_ret_pis + '</td>';
            item += '<td>' + operacao.parcelas[i].op_parcela_ret_cofins + '</td>';
            item += '<td>' + operacao.parcelas[i].op_parcela_ret_csll + '</td>';
            item += '<td style="white-space:nowrap">' + operacao.parcelas[i].op_parcela_obs + '</td>';            
            item += '</tr>';
            $('#tbody_parcelas').append(item);

            valor_liquido += convertStringDouble(operacao.parcelas[i].op_parcela_valor);
        }

        if (operacao.parcelas.length > 0) {
            document.getElementById('parcelas').value = 'Número Parcelas: ' + operacao.parcelas.length + ' Valor Liquido: ' + convertDoubleString(valor_liquido);
        } else {
            document.getElementById('parcelas').value = 'Não informado';
        }
    }

    function operacao_parcelas(contexto, op_parcela_numero) {
        if (contexto == 'open') {
            //Atualiza a view com as parcelas
            atualizaViewParcelas();

            //Abrir modal
            modal_sobre_modal_open('lista_parcelas');

            if (document.getElementById('op_parcela_fp_id')) {
                document.getElementById('op_parcela_fp_id').focus();
            }
        }

        if (contexto == 'gerar') {
            let forma_gerar_parcelas = convertStringDouble(document.getElementById('parcela_forma_gerar').value);
            let valor_operacao = convertStringDouble(operacao.totais.op_totais_total_op);

            if (valor_operacao > 0) {
                if (forma_gerar_parcelas == 1) {
                    gera_parcelas_dia_vencimento();
                    atualizaViewParcelas();
                }

                if (forma_gerar_parcelas == 3) {
                    gera_parcelas_numero_parcelas();
                    atualizaViewParcelas();
                }
            } else {
                alert('Operação sem valor para geração de parcelas!');
            }
        }

        if (contexto == 'edit_open') {
            for (let i = 0; i < operacao.parcelas.length; i++) {
                if (operacao.parcelas[i].op_parcela_numero == op_parcela_numero) {
                    document.getElementById('op_parcela_vencimento').value = operacao.parcelas[i].op_parcela_vencimento;
                    document.getElementById('op_parcela_valor_bruto').value = operacao.parcelas[i].op_parcela_valor_bruto;
                    document.getElementById('op_parcela_valor').value = operacao.parcelas[i].op_parcela_valor;
                    document.getElementById('op_parcela_ret_irrf').value = operacao.parcelas[i].op_parcela_ret_irrf;
                    document.getElementById('op_parcela_ret_inss').value = operacao.parcelas[i].op_parcela_ret_inss;
                    document.getElementById('op_parcela_ret_issqn').value = operacao.parcelas[i].op_parcela_ret_issqn;
                    document.getElementById('op_parcela_ret_pis').value = operacao.parcelas[i].op_parcela_ret_pis;
                    document.getElementById('op_parcela_ret_cofins').value = operacao.parcelas[i].op_parcela_ret_cofins;
                    document.getElementById('op_parcela_ret_csll').value = operacao.parcelas[i].op_parcela_ret_csll;
                    document.getElementById('op_parcela_obs').value = operacao.parcelas[i].op_parcela_obs;
                    document.getElementById('op_parcela_numero').value = operacao.parcelas[i].op_parcela_numero;
                    //Atribuindo a categoria no select2
                    if (document.getElementById('op_parcela_fp_id_edit')) {
                        $('#op_parcela_fp_id_edit').val(operacao.parcelas[i].op_parcela_fp_id);
                        $('#op_parcela_fp_id_edit').trigger('change');
                    }
                    let btn = '<button type="button" id="btn_parcela_cancelar" class="btn btn-sm btn-danger" style="width:50%;float:left;" onclick="operacao_parcelas(\'cancelar_edit\')">Cancelar</button>';
                    btn += '<button type="button" id="btn_parcela" class="btn btn-sm btn-info" style="width:50%;float:left;" onclick="operacao_parcelas(\'gravar\')">Gravar Alteração</button>';

                    document.getElementById('btn_action').innerHTML = btn;

                    break;
                }

                if (document.getElementById('op_parcela_fp_id_edit')) {
                    document.getElementById('op_parcela_fp_id_edit').focus();
                }
            }

            //Habilita tab 2 na tela
            $('#myTab li:nth-child(2) a').tab('show')
        }

        if (contexto == 'gravar') {
            let op_parcela_vencimento = moment(document.getElementById('op_parcela_vencimento').value, 'DD/MM/YYYY', 'pt', true);
            if (op_parcela_vencimento.isValid() && convertStringDouble(document.getElementById('op_parcela_valor_bruto').value) > 0 && convertStringDouble(document.getElementById('op_parcela_fp_id_edit').value) > 0) {
                let op_parcela_numero = convertStringDouble(document.getElementById('op_parcela_numero').value);
                for (let i = 0; i < operacao.parcelas.length; i++) {
                    if (operacao.parcelas[i].op_parcela_numero == op_parcela_numero) {
                        operacao.parcelas[i].op_parcela_vencimento = document.getElementById('op_parcela_vencimento').value;
                        operacao.parcelas[i].op_parcela_valor_bruto = document.getElementById('op_parcela_valor_bruto').value;
                        operacao.parcelas[i].op_parcela_valor = document.getElementById('op_parcela_valor').value;
                        operacao.parcelas[i].op_parcela_ret_irrf = document.getElementById('op_parcela_ret_irrf').value;
                        operacao.parcelas[i].op_parcela_ret_inss = document.getElementById('op_parcela_ret_inss').value;
                        operacao.parcelas[i].op_parcela_ret_issqn = document.getElementById('op_parcela_ret_issqn').value;
                        operacao.parcelas[i].op_parcela_ret_pis = document.getElementById('op_parcela_ret_pis').value;
                        operacao.parcelas[i].op_parcela_ret_cofins = document.getElementById('op_parcela_ret_cofins').value;
                        operacao.parcelas[i].op_parcela_ret_csll = document.getElementById('op_parcela_ret_csll').value;
                        operacao.parcelas[i].op_parcela_obs = document.getElementById('op_parcela_obs').value;
                        operacao.parcelas[i].op_parcela_fp_id = document.getElementById('op_parcela_fp_id_edit').value;
                        operacao.parcelas[i].op_parcela_label_forma_pgto = $('#op_parcela_fp_id_edit :selected').text();

                        //Limpando campos da tela
                        document.getElementById('op_parcela_vencimento').value = '';
                        document.getElementById('op_parcela_valor_bruto').value = '';
                        document.getElementById('op_parcela_valor').value = '';
                        document.getElementById('op_parcela_ret_irrf').value = '';
                        document.getElementById('op_parcela_ret_inss').value = '';
                        document.getElementById('op_parcela_ret_issqn').value = '';
                        document.getElementById('op_parcela_ret_pis').value = '';
                        document.getElementById('op_parcela_ret_cofins').value = '';
                        document.getElementById('op_parcela_ret_csll').value = '';
                        document.getElementById('op_parcela_obs').value = '';
                        document.getElementById('op_parcela_numero').value = '';

                        //altera btn da tela
                        let btn_2 = '<button type="button" id="btn_parcela_cancelar" class="btn btn-sm btn-outline-danger" style="width:50%;float:left;" onclick="operacao_parcelas(\'cancelar_incluir\')">Cancelar</button>';
                        btn_2 += '<button type="button" id="btn_parcela" class="btn btn-sm btn-outline-info" style="width:50%;float:left;" onclick="operacao_parcelas(\'incluir\')">Incluir Parcela</button>';
                        document.getElementById('btn_action').innerHTML = btn_2;

                        break;
                    }
                }
                atualizaViewParcelas();                
            } else {
                alert('Data de Vencimento ou Valor Bruto são inválidos!');
            }
        }

        if (contexto == 'incluir') {
            let op_data = moment(document.getElementById('op_data').value, 'DD/MM/YYYY', 'pt', true);
            let op_parcela_vencimento = moment(document.getElementById('op_parcela_vencimento').value, 'DD/MM/YYYY', 'pt', true);
            let duracao = moment.duration(op_data.diff(op_parcela_vencimento));
            let dias = duracao.asDays();

            if (op_parcela_vencimento.isValid() && convertStringDouble(document.getElementById('op_parcela_valor_bruto').value) > 0 && convertStringDouble(document.getElementById('op_parcela_fp_id_edit').value) > 0) {
                p = {
                    op_parcela_id: 0,
                    op_parcela_dias: (dias * -1),
                    op_parcela_vencimento: op_parcela_vencimento.format('DD/MM/YYYY'),
                    op_parcela_fp_id: document.getElementById('op_parcela_fp_id_edit').value,
                    op_parcela_op_id: 0,
                    op_parcela_valor: document.getElementById('op_parcela_valor').value,
                    op_parcela_obs: '',
                    op_parcela_saldo: '',
                    op_parcela_ret_inss: document.getElementById('op_parcela_ret_inss').value,
                    op_parcela_ret_issqn: document.getElementById('op_parcela_ret_issqn').value,
                    op_parcela_ret_irrf: document.getElementById('op_parcela_ret_irrf').value,
                    op_parcela_ret_pis: document.getElementById('op_parcela_ret_pis').value,
                    op_parcela_ret_cofins: document.getElementById('op_parcela_ret_cofins').value,
                    op_parcela_ret_csll: document.getElementById('op_parcela_ret_csll').value,
                    op_parcela_valor_bruto: document.getElementById('op_parcela_valor_bruto').value,
                    op_parcela_agrupamento: 0,
                    op_parcela_vencimento_alterado: op_parcela_vencimento.format('DD/MM/YYYY'),
                    op_parcela_numero: 0,
                    op_parcela_numero_total: 0,
                    op_parcela_label_forma_pgto: $('#op_parcela_fp_id_edit :selected').text(),
                };
                operacao.parcelas.push(p);

                //Ordenando parcelas
                operacao.parcelas.sort(function (a, b) { return a.op_parcela_dias - b.op_parcela_dias });
                //Atualizando números sequencias de parcelas
                for (let i = 0; i < operacao.parcelas.length; i++) {
                    operacao.parcelas[i].op_parcela_numero = i + 1;
                    operacao.parcelas[i].op_parcela_numero_total = operacao.parcelas.length;
                }

                //Limpando campos da tela
                document.getElementById('op_parcela_vencimento').value = '';
                document.getElementById('op_parcela_valor_bruto').value = '';
                document.getElementById('op_parcela_valor').value = '';
                document.getElementById('op_parcela_ret_irrf').value = '';
                document.getElementById('op_parcela_ret_inss').value = '';
                document.getElementById('op_parcela_ret_issqn').value = '';
                document.getElementById('op_parcela_ret_pis').value = '';
                document.getElementById('op_parcela_ret_cofins').value = '';
                document.getElementById('op_parcela_ret_csll').value = '';
                document.getElementById('op_parcela_obs').value = '';
                document.getElementById('op_parcela_numero').value = '';

                //Atualizar view
                atualizaViewParcelas();
            } else {
                alert('Data de Vencimento ou Valor Bruto são inválidos!');
            }
        }

        if (contexto == 'close') {
            let valor_bruto_parcelas = 0;
            let valor_liquido = 0;

            for (let i = 0; i < operacao.parcelas.length; i++) {
                valor_bruto_parcelas += convertStringDouble(operacao.parcelas[i].op_parcela_valor_bruto);
                valor_liquido += convertStringDouble(operacao.parcelas[i].op_parcela_valor);
            }

            if (convertStringDouble(valor_bruto_parcelas.toFixed(2)) > convertStringDouble(convertStringDouble(operacao.totais.op_totais_total_op).toFixed(2))) {
                alert('Soma do valor bruto das parcelas é maior que o valor total da operação!');
                return;
            }

            somatoriaRetencoes();

            if (operacao.parcelas.length > 0) {
                document.getElementById('parcelas').value = 'Número Parcelas: ' + operacao.parcelas.length + ' Valor Liquido: ' + convertDoubleString(valor_liquido);
            } else {
                document.getElementById('parcelas').value = 'Não informado';
            }

            $('#lista_parcelas').modal('hide'); //Fechar modal se estiver aberto

            if (document.getElementById('btn_documento')) {
                document.getElementById('btn_documento').focus();
            }
        }

        if (contexto == 'delete_confirmar') {
            document.getElementById('parcela_excluir').innerHTML = 'Confirma a exclusão da parcela: ' + op_parcela_numero + '?';
            document.getElementById('parcela_delete').value = op_parcela_numero;
            //Abrir modal
            modal_sobre_modal_open('modal_parcela_delete');
        }

        if (contexto == 'delete_confirmado') {
            let codigo = document.getElementById('parcela_delete').value;

            for (let i = 0; i < operacao.parcelas.length; i++) {
                if (operacao.parcelas[i].op_parcela_numero == convertStringDouble(codigo)) {
                    operacao.parcelas.splice(i, 1);
                }
            }
            //Atualizando números sequencias de parcelas
            for (let i = 0; i < operacao.parcelas.length; i++) {
                operacao.parcelas[i].op_parcela_numero = i + 1;
                operacao.parcelas[i].op_parcela_numero_total = operacao.parcelas.length;
            }
            //Atualiza as retenções
            somatoriaRetencoes();
            //Atualizar view
            atualizaViewParcelas();
            //Fecha modal de confirmação
            $('#modal_parcela_delete').modal('hide');
        }

        if (contexto == 'cancelar_edit') {
            //Limpando campos da tela
            document.getElementById('op_parcela_vencimento').value = '';
            document.getElementById('op_parcela_valor_bruto').value = '';
            document.getElementById('op_parcela_valor').value = '';
            document.getElementById('op_parcela_ret_irrf').value = '';
            document.getElementById('op_parcela_ret_inss').value = '';
            document.getElementById('op_parcela_ret_issqn').value = '';
            document.getElementById('op_parcela_ret_pis').value = '';
            document.getElementById('op_parcela_ret_cofins').value = '';
            document.getElementById('op_parcela_ret_csll').value = '';
            document.getElementById('op_parcela_obs').value = '';
            document.getElementById('op_parcela_numero').value = '';

            //altera btn da tela
            let btn_2 = '<button type="button" id="btn_parcela_cancelar" class="btn btn-sm btn-outline-danger" style="width:50%;float:left;" onclick="operacao_parcelas(\'cancelar_incluir\')">Cancelar</button>';
            btn_2 += '<button type="button" id="btn_parcela" class="btn btn-sm btn-outline-info" style="width:50%;float:left;" onclick="operacao_parcelas(\'incluir\')">Incluir Parcela</button>';
            document.getElementById('btn_action').innerHTML = btn_2;
        }

        if (contexto == 'cancelar_incluir') {
            //Limpando campos da tela
            document.getElementById('op_parcela_vencimento').value = '';
            document.getElementById('op_parcela_valor_bruto').value = '';
            document.getElementById('op_parcela_valor').value = '';
            document.getElementById('op_parcela_ret_irrf').value = '';
            document.getElementById('op_parcela_ret_inss').value = '';
            document.getElementById('op_parcela_ret_issqn').value = '';
            document.getElementById('op_parcela_ret_pis').value = '';
            document.getElementById('op_parcela_ret_cofins').value = '';
            document.getElementById('op_parcela_ret_csll').value = '';
            document.getElementById('op_parcela_obs').value = '';
            document.getElementById('op_parcela_numero').value = '';
        }

    }

    function gera_parcelas_dia_vencimento() {
        //Limpar parcelas atuais para nova geração
        operacao.parcelas.splice(0, operacao.parcelas.length);

        let valor_operacao = convertStringDouble(operacao.totais.op_totais_total_op);
        let cheque_csrf = document.getElementById('csrf').checked;
        let forma_pagamento_label = $('#op_parcela_fp_id :selected').text();
        let forma_pagamento = document.getElementById('op_parcela_fp_id').value;
        let parcelas = (document.getElementById('parcela_dia_vencimento').value).toString().replace('.', ',').split(',');
        let valor_bruto = valor_operacao / parcelas.length;
        let op_data = document.getElementById('op_data').value; 

        let parcelas_reducao = valor_operacao;
        
        for (let i = 0; i < parcelas.length; i++) {
            
            let data = moment(op_data, 'DD/MM/YYYY', 'pt', true);
            p = {
                op_parcela_id: 0,
                op_parcela_dias: convertStringDouble(parcelas[i]),
                op_parcela_vencimento: data.add(convertStringDouble(parcelas[i]), 'd').format('DD/MM/YYYY'),
                op_parcela_fp_id: forma_pagamento,
                op_parcela_op_id: 0,
                op_parcela_valor: '',
                op_parcela_obs: '',
                op_parcela_saldo: '',
                op_parcela_ret_inss: '',
                op_parcela_ret_issqn: '',
                op_parcela_ret_irrf: '',
                op_parcela_ret_pis: '',
                op_parcela_ret_cofins: '',
                op_parcela_ret_csll: '',
                op_parcela_valor_bruto: 0,
                op_parcela_agrupamento: 0,
                op_parcela_vencimento_alterado: data.add(convertStringDouble(parcelas[i]), 'd').format('DD/MM/YYYY'),
                op_parcela_numero: (i + 1),
                op_parcela_numero_total: parcelas.length,
                op_parcela_label_forma_pgto: forma_pagamento_label,
            };

            if (i < (parcelas.length - 1)) {
                p.op_parcela_valor_bruto = convertDoubleString(valor_bruto);
            } else {
                p.op_parcela_valor_bruto = convertDoubleString(parcelas_reducao);
            }

            parcelas_reducao = parcelas_reducao - convertStringDouble(p.op_parcela_valor_bruto);

            

            //inss
            if (convertStringDouble(operacao.retencoes.op_ret_inss) > 0) {
                if (document.getElementById('ret_inss_parcela').checked == true) {
                    if (i == 0) {
                        p.op_parcela_ret_inss = operacao.retencoes.op_ret_inss;
                    }                    
                } else {
                    p.op_parcela_ret_inss = convertDoubleString(convertStringDouble(operacao.retencoes.op_ret_inss) / parcelas.length);
                }
            }
            //issqn
            if (convertStringDouble(operacao.retencoes.op_ret_issqn) > 0) {
                if (document.getElementById('ret_iss_parcela').checked == true) {
                    if (i == 0) {
                        p.op_parcela_ret_issqn = operacao.retencoes.op_ret_issqn;
                    }                    
                } else {
                    p.op_parcela_ret_issqn = convertDoubleString(convertStringDouble(operacao.retencoes.op_ret_issqn) / parcelas.length);
                }
            }
            //irrf
            if (convertStringDouble(operacao.retencoes.op_ret_irrf) > 0) {
                if (document.getElementById('ret_irrf_parcela').checked == true) {
                    if (i == 0) {
                        p.op_parcela_ret_irrf = operacao.retencoes.op_ret_irrf;
                    }                    
                } else {
                    p.op_parcela_ret_irrf = convertDoubleString(convertStringDouble(operacao.retencoes.op_ret_irrf) / parcelas.length);
                }
            }
            //csrf
            let vlr_parcela = convertStringDouble(p.op_parcela_valor_bruto);
            if (cheque_csrf == true) {
                if (vlr_parcela > 215.05) {
                    p.op_parcela_ret_pis = convertDoubleString(vlr_parcela * 0.65 / 100);
                    p.op_parcela_ret_cofins = convertDoubleString(vlr_parcela * 3 / 100);
                    p.op_parcela_ret_csll = convertDoubleString(vlr_parcela * 1 / 100);
                }
            }
            //valor parcela
            p.op_parcela_valor = convertDoubleString(vlr_parcela - (convertStringDouble(p.op_parcela_ret_inss) + convertStringDouble(p.op_parcela_ret_issqn) + convertStringDouble(p.op_parcela_ret_irrf) + convertStringDouble(p.op_parcela_ret_pis) + convertStringDouble(p.op_parcela_ret_cofins) + convertStringDouble(p.op_parcela_ret_csll)));

            operacao.parcelas.push(p);
        }        
    }    

    function gera_parcelas_numero_parcelas() {
        //Limpar parcelas atuais para nova geração
        operacao.parcelas.splice(0, operacao.parcelas.length);

        let valor_operacao = convertStringDouble(operacao.totais.op_totais_total_op);
        let cheque_csrf = document.getElementById('csrf').checked;
        let forma_pagamento_label = $('#op_parcela_fp_id :selected').text();
        let forma_pagamento = document.getElementById('op_parcela_fp_id').value;
        let parcelas = convertStringDouble(document.getElementById('parcela_numero').value);
        let valor_bruto = valor_operacao / parcelas;
        let op_data = moment(document.getElementById('op_data').value, 'DD/MM/YYYY', 'pt', true);
        let recorrencia = document.getElementById('recorencia_n_parcelas').value;
        let data = moment(document.getElementById('data_primeira_parcela').value, 'DD/MM/YYYY', 'pt', true);

        let parcelas_reducao = valor_operacao; 

        for (let i = 0; i < parcelas; i++) {            
            p = {
                op_parcela_id: 0,
                op_parcela_dias: 0,
                op_parcela_vencimento: '',
                op_parcela_fp_id: forma_pagamento,
                op_parcela_op_id: 0,
                op_parcela_valor: '',
                op_parcela_obs: '',
                op_parcela_saldo: '',
                op_parcela_ret_inss: '',
                op_parcela_ret_issqn: '',
                op_parcela_ret_irrf: '',
                op_parcela_ret_pis: '',
                op_parcela_ret_cofins: '',
                op_parcela_ret_csll: '',
                op_parcela_valor_bruto: 0,
                op_parcela_agrupamento: 0,
                op_parcela_vencimento_alterado: '',
                op_parcela_numero: (i + 1),
                op_parcela_numero_total: parcelas,
                op_parcela_label_forma_pgto: forma_pagamento_label,
            };         

            if (i < (parcelas - 1)) {
                p.op_parcela_valor_bruto = convertDoubleString(valor_bruto);
            } else {
                p.op_parcela_valor_bruto = convertDoubleString(parcelas_reducao);
            }

            parcelas_reducao = parcelas_reducao - convertStringDouble(p.op_parcela_valor_bruto);

            //Vencimento
            if (i == 0) {
                p.op_parcela_vencimento = data.format('DD/MM/YYYY');
            } else {
                if (recorrencia == 'Semanal') {
                    p.op_parcela_vencimento = data.add(7, 'd').format('DD/MM/YYYY');
                }
                if (recorrencia == 'Quinzenal') {
                    p.op_parcela_vencimento = data.add(15, 'd').format('DD/MM/YYYY');
                }
                if (recorrencia == 'Mensal') {
                    p.op_parcela_vencimento = data.add(1, 'M').format('DD/MM/YYYY');
                }
                if (recorrencia == 'Bimestral') {
                    p.op_parcela_vencimento = data.add(2, 'M').format('DD/MM/YYYY');
                }
                if (recorrencia == 'Trimestral') {
                    p.op_parcela_vencimento = data.add(3, 'M').format('DD/MM/YYYY');
                }
                if (recorrencia == 'Semestral') {
                    p.op_parcela_vencimento = data.add(6, 'M').format('DD/MM/YYYY');
                }
                if (recorrencia == 'Anual') {
                    p.op_parcela_vencimento = data.add(1, 'y').format('DD/MM/YYYY');
                }
            }
            p.op_parcela_vencimento_alterado = p.op_parcela_vencimento;

            //Dias
            let duracao = moment.duration(op_data.diff(data));
            let dias = duracao.asDays();
            p.op_parcela_dias = (dias * -1);


            //inss
            if (convertStringDouble(operacao.retencoes.op_ret_inss) > 0) {
                if (document.getElementById('ret_inss_parcela').checked == true) {
                    if (i == 0) {
                        p.op_parcela_ret_inss = operacao.retencoes.op_ret_inss;
                    }
                } else {
                    p.op_parcela_ret_inss = convertDoubleString(convertStringDouble(operacao.retencoes.op_ret_inss) / parcelas.length);
                }
            }
            //issqn
            if (convertStringDouble(operacao.retencoes.op_ret_issqn) > 0) {
                if (document.getElementById('ret_iss_parcela').checked == true) {
                    if (i == 0) {
                        p.op_parcela_ret_issqn = operacao.retencoes.op_ret_issqn;
                    }
                } else {
                    p.op_parcela_ret_issqn = convertDoubleString(convertStringDouble(operacao.retencoes.op_ret_issqn) / parcelas.length);
                }
            }
            //irrf
            if (convertStringDouble(operacao.retencoes.op_ret_irrf) > 0) {
                if (document.getElementById('ret_irrf_parcela').checked == true) {
                    if (i == 0) {
                        p.op_parcela_ret_irrf = operacao.retencoes.op_ret_irrf;
                    }
                } else {
                    p.op_parcela_ret_irrf = convertDoubleString(convertStringDouble(operacao.retencoes.op_ret_irrf) / parcelas.length);
                }
            }
            //csrf
            let vlr_parcela = convertStringDouble(p.op_parcela_valor_bruto);
            if (cheque_csrf == true) {
                if (vlr_parcela > 215.05) {
                    p.op_parcela_ret_pis = convertDoubleString(vlr_parcela * 0.65 / 100);
                    p.op_parcela_ret_cofins = convertDoubleString(vlr_parcela * 3 / 100);
                    p.op_parcela_ret_csll = convertDoubleString(vlr_parcela * 1 / 100);
                }
            }
            //valor parcela
            p.op_parcela_valor = convertDoubleString(vlr_parcela - (convertStringDouble(p.op_parcela_ret_inss) + convertStringDouble(p.op_parcela_ret_issqn) + convertStringDouble(p.op_parcela_ret_irrf) + convertStringDouble(p.op_parcela_ret_pis) + convertStringDouble(p.op_parcela_ret_cofins) + convertStringDouble(p.op_parcela_ret_csll)));

            operacao.parcelas.push(p);
        }
    }

    function edit_valores_parcela(id, vlr) {
        if (isNaN(vlr.replaceAll('.', '').replaceAll(',', '.') * 1)) {
            alert('O valor: ' + vlr + ' não é número. Digite um número separado por vírgula no decimal.');
            document.getElementById(id).value = (0).toFixed(2);
            document.getElementById(id).focus();
            return;
        }

        let valor_bruto = convertStringDouble(document.getElementById('op_parcela_valor_bruto').value);
        let inss = convertStringDouble(document.getElementById('op_parcela_ret_inss').value);
        let irrf = convertStringDouble(document.getElementById('op_parcela_ret_irrf').value);
        let iss = convertStringDouble(document.getElementById('op_parcela_ret_issqn').value);
        let pis = convertStringDouble(document.getElementById('op_parcela_ret_pis').value);
        let cofins = convertStringDouble(document.getElementById('op_parcela_ret_cofins').value);
        let csll = convertStringDouble(document.getElementById('op_parcela_ret_csll').value);

        decimal('op_parcela_valor_bruto', valor_bruto, '2', false);
        decimal('op_parcela_ret_inss', inss, '2', false);
        decimal('op_parcela_ret_irrf', irrf, '2', false);
        decimal('op_parcela_ret_issqn', iss, '2', false);
        decimal('op_parcela_ret_pis', pis, '2', false);
        decimal('op_parcela_ret_cofins', cofins, '2', false);
        decimal('op_parcela_ret_csll', csll, '2', false);
        
        decimal(id, vlr, '2', true);
        let valor_liquido = valor_bruto - inss - irrf - iss - pis - cofins - csll;
        document.getElementById('op_parcela_valor').value = valor_liquido.toLocaleString("pt-BR", { style: "decimal", minimumFractionDigits: "2", maximumFractionDigits: "2" });
    }

    function editRetencoes(id, vlr, contexto) {
        if (isNaN(vlr.replaceAll('.', '').replaceAll(',', '.') * 1)) {
            alert('O valor: ' + vlr + ' não é número. Digite um número separado por vírgula no decimal.');
            document.getElementById(id).value = (0).toFixed(2);
            document.getElementById(id).focus();
            return;
        }

        $('#modal_mensagem_retorno').modal('hide'); //Fechar modal se estiver aberto    

        if (operacao.parcelas.length > 0) {
            if (contexto == 'confirmar') {
                document.getElementById('mensagem_retorno_label').innerHTML = "";
                document.getElementById('mensagem_retorno_label').innerHTML = "Alteração de Retenção";
                document.getElementById('mensagem_retorno_conteudo').innerHTML = "";
                document.getElementById('mensagem_retorno_conteudo').innerHTML = "<p>" + 'A operação possui parcelas informadas. Como deseja proceder com o valor informado?' + "</p>";
                document.getElementById('mensagem_retorno_conteudo').innerHTML += '<div class="row"><div class="col-12"><button type="button" class="btn btn-info" style="width: 100%;margin-bottom: 10px;" onclick="editRetencoes(\'' + id + '\',\'' + vlr + '\',\'confirmadoDiluir\')">Distribuir o valor em todas as parcelas</button></div><div class="col-12"><button type="button" class="btn btn-info" style="width: 100%;margin-bottom: 10px;" onclick="editRetencoes(\'' + id + '\',\'' + vlr + '\',\'confirmadoPrimeira\')">Descontar na primeira parcela</button></div></div>';
                document.getElementById('mensagem_retorno_rodape').innerHTML = "";
                $('#modal_mensagem_retorno').modal('show');
            }

            if (contexto != 'confirmar') {
                for (let i = 0; i < operacao.parcelas.length; i++) {

                    if (contexto == 'confirmadoDiluir') {
                        if (id == 'op_ret_inss') {
                            operacao.parcelas[i].op_parcela_ret_inss = convertDoubleString((convertStringDouble(vlr) / operacao.parcelas.length));
                        }
                        if (id == 'op_ret_issqn') {
                            operacao.parcelas[i].op_parcela_ret_issqn = convertDoubleString((convertStringDouble(vlr) / operacao.parcelas.length));
                        }
                        if (id == 'op_ret_irrf') {
                            operacao.parcelas[i].op_parcela_ret_irrf = convertDoubleString((convertStringDouble(vlr) / operacao.parcelas.length));
                        }
                    }

                    if (contexto == 'confirmadoPrimeira') {
                        if (i == 0) {
                            if (id == 'op_ret_inss') {
                                operacao.parcelas[0].op_parcela_ret_inss = convertDoubleString((convertStringDouble(vlr)));
                            }
                            if (id == 'op_ret_issqn') {
                                operacao.parcelas[0].op_parcela_ret_issqn = convertDoubleString((convertStringDouble(vlr)));
                            }
                            if (id == 'op_ret_irrf') {
                                operacao.parcelas[0].op_parcela_ret_irrf = convertDoubleString((convertStringDouble(vlr)));
                            }
                        } else {
                            if (id == 'op_ret_inss') {
                                operacao.parcelas[i].op_parcela_ret_inss = convertDoubleString(0);
                            }
                            if (id == 'op_ret_issqn') {
                                operacao.parcelas[i].op_parcela_ret_issqn = convertDoubleString(0);
                            }
                            if (id == 'op_ret_irrf') {
                                operacao.parcelas[i].op_parcela_ret_irrf = convertDoubleString(0);
                            }
                        }
                    }
                    
                    let inss = convertStringDouble(operacao.parcelas[i].op_parcela_ret_inss);
                    let iss = convertStringDouble(operacao.parcelas[i].op_parcela_ret_issqn);
                    let ir = convertStringDouble(operacao.parcelas[i].op_parcela_ret_irrf);
                    let pis = convertStringDouble(operacao.parcelas[i].op_parcela_ret_pis);
                    let cofins = convertStringDouble(operacao.parcelas[i].op_parcela_ret_cofins);
                    let csll = convertStringDouble(operacao.parcelas[i].op_parcela_ret_csll);
                    let valor_bruto = convertStringDouble(operacao.parcelas[i].op_parcela_valor_bruto);

                    operacao.parcelas[i].op_parcela_valor = convertDoubleString(valor_bruto - inss - iss - ir - pis - cofins - csll);
                }
            }

            //Atualiza parcelas para refazer informações da view
            atualizaViewParcelas();

            somatoriaRetencoes();

            decimal(id, convertStringDouble(vlr), '2', true);

        } else {
            decimal(id, convertStringDouble(vlr), '2', true);
        }

        //atualizando retenções
        if (id == 'op_ret_inss') {
            operacao.retencoes.op_ret_inss = convertDoubleString(convertStringDouble(vlr));            
        }
        if (id == 'op_ret_issqn') {
            operacao.retencoes.op_ret_issqn = convertDoubleString(convertStringDouble(vlr));
        }
        if (id == 'op_ret_irrf') {
            operacao.retencoes.op_ret_irrf = convertDoubleString(convertStringDouble(vlr));
        }
    }

    function somatoriaRetencoes() {

        let inss = 0;
        let iss = 0;
        let ir = 0;
        let pis = 0;
        let cofins = 0;
        let csll = 0;        

        for (let i = 0; i < operacao.parcelas.length; i++) {
            inss += convertStringDouble(operacao.parcelas[i].op_parcela_ret_inss);
            iss += convertStringDouble(operacao.parcelas[i].op_parcela_ret_issqn);
            ir += convertStringDouble(operacao.parcelas[i].op_parcela_ret_irrf);
            pis += convertStringDouble(operacao.parcelas[i].op_parcela_ret_pis);
            cofins += convertStringDouble(operacao.parcelas[i].op_parcela_ret_cofins);
            csll += convertStringDouble(operacao.parcelas[i].op_parcela_ret_csll);
        }

        decimal('op_ret_inss', inss, '2', false);
        decimal('op_ret_issqn', iss, '2', false);
        decimal('op_ret_irrf', ir, '2', false);
        decimal('op_ret_pis', pis, '2', false);
        decimal('op_ret_cofins', cofins, '2', false);
        decimal('op_ret_csll', csll, '2', false);

        //atribuir as retenções das parcelas em retenções objeto
        operacao.retencoes.op_ret_inss = convertDoubleString(inss);
        operacao.retencoes.op_ret_issqn = convertDoubleString(iss);
        operacao.retencoes.op_ret_irrf = convertDoubleString(ir);
        operacao.retencoes.op_ret_pis = convertDoubleString(pis);
        operacao.retencoes.op_ret_cofins = convertDoubleString(cofins);
        operacao.retencoes.op_ret_csll = convertDoubleString(csll);

        //Atribuir informação na operação se op é com retenções
        if (inss > 0 || iss > 0 || ir > 0 || pis > 0 || cofins > 0 || csll > 0) {
            operacao.operacao.op_comRetencoes = true;
        } else {
            operacao.operacao.op_comRetencoes = false;
        }

        let txt = '';
        let soma = 0;

        if (convertStringDouble(operacao.retencoes.op_ret_inss) > 0) {
            txt += 'INSS: ' + operacao.retencoes.op_ret_inss + ' ';
            soma += convertStringDouble(operacao.retencoes.op_ret_inss);
        }
        if (convertStringDouble(operacao.retencoes.op_ret_issqn) > 0) {
            txt += 'ISSQN: ' + operacao.retencoes.op_ret_issqn + ' ';
            soma += convertStringDouble(operacao.retencoes.op_ret_issqn);
        }
        if (convertStringDouble(operacao.retencoes.op_ret_irrf) > 0) {
            txt += 'IRRF: ' + operacao.retencoes.op_ret_irrf + ' ';
            soma += convertStringDouble(operacao.retencoes.op_ret_irrf);
        }
        if (convertStringDouble(operacao.retencoes.op_ret_pis) > 0) {
            txt += 'PIS: ' + operacao.retencoes.op_ret_pis + ' ';
            soma += convertStringDouble(operacao.retencoes.op_ret_pis);
        }
        if (convertStringDouble(operacao.retencoes.op_ret_cofins) > 0) {
            txt += 'COFINS: ' + operacao.retencoes.op_ret_cofins + ' ';
            soma += convertStringDouble(operacao.retencoes.op_ret_cofins);
        }
        if (convertStringDouble(operacao.retencoes.op_ret_csll) > 0) {
            txt += 'CSLL: ' + operacao.retencoes.op_ret_csll + ' ';
            soma += convertStringDouble(operacao.retencoes.op_ret_csll);
        }

        if (soma > 0) {
            document.getElementById('retencoes').value = txt;
        } else {
            document.getElementById('retencoes').value = 'Não informado';
        }
    }

    function operacao_documento(contexto) {
        if (contexto == 'open') {
            document.getElementById('op_nf_tipo').value = operacao.nf.op_nf_tipo;
            document.getElementById('op_nf_data_emissao').value = operacao.nf.op_nf_data_emissao;
            document.getElementById('op_nf_serie').value = operacao.nf.op_nf_serie;
            document.getElementById('op_nf_numero').value = operacao.nf.op_nf_numero;
            document.getElementById('op_nf_chave').value = operacao.nf.op_nf_chave;

            //Abrir modal
            modal_sobre_modal_open('lista_dctos_fiscais');

            document.getElementById('op_nf_tipo').focus();
        }

        if (contexto == 'save') {
            document.getElementById('box_valid').innerHTML = '';
            let op_nf_data_emissao = moment(document.getElementById('op_nf_data_emissao').value, 'DD/MM/YYYY', 'pt', true);
            let serie = document.getElementById('op_nf_serie').value;
            let numero = document.getElementById('op_nf_numero').value;
            let chave = document.getElementById('op_nf_chave').value;

            let str = '';

            if (!op_nf_data_emissao.isValid()) {
                str += 'Data de emissão inválida;';
            }

            if (serie.length < 1) {
                str += 'Série é obrigatória;';
            }

            if (numero.length < 1) {
                str += 'Número é obrigatório;';
            }

            if (chave.length > 1 && chave.length != 44) {
                str += 'Chave de Acesso deve ter 44 caracteres;';
            }

            if (str.length > 0) {                
                let m = str.split(';');
                for (let i = 0; i < m.length; i++) {
                    let v = '<span class="text-danger">'+ m[i] +'</span></br>';
                    $('#box_valid').append(v);
                }
            } else {
                operacao.nf.op_nf_tipo = document.getElementById('op_nf_tipo').value;
                operacao.nf.op_nf_data_emissao = op_nf_data_emissao.format('DD/MM/YYYY');
                operacao.nf.op_nf_serie = serie;
                operacao.nf.op_nf_numero = numero;
                operacao.nf.op_nf_chave = chave;

                document.getElementById('documento').value = 'Número: ' + numero + ' Série: ' + serie;

                //gravando informação que operação é com nf
                operacao.operacao.op_comNF = document.getElementById('op_nf_tipo').value;

                if (document.getElementById('op_obs')) {
                    if (document.getElementById('documento').value != 'Não informado') {
                        let t = 'Ref.: ' + $('#op_nf_tipo :selected').text() + ' Número: ' + operacao.nf.op_nf_numero + ' Série: ' + operacao.nf.op_nf_serie + ".";
                        if (!document.getElementById('op_obs').value.includes(t)) {
                            document.getElementById('op_obs').value += t;
                        } 
                    }                    
                }

                $('#lista_dctos_fiscais').modal('hide');

                document.getElementById('op_obs').focus();
            }
        }

        if (contexto == 'delete_confirmar') {
            //Abrir modal
            modal_sobre_modal_open('modal_delete_dcto');
        }

        if (contexto == 'delete_confirmado') {
            //Limpando objeto
            operacao.nf.op_nf_tipo = 0;
            operacao.nf.op_nf_data_emissao = '';
            operacao.nf.op_nf_serie = '';
            operacao.nf.op_nf_numero = '';
            operacao.nf.op_nf_chave = '';

            //Limpando tela            
            document.getElementById('op_nf_data_emissao').value = '';
            document.getElementById('op_nf_serie').value = '';
            document.getElementById('op_nf_numero').value = '';
            document.getElementById('op_nf_chave').value = '';

            document.getElementById('documento').value = 'Não informado';

            //gravando informação que operação é sem nf
            operacao.operacao.op_comNF = 0;

            if (document.getElementById('op_obs')) {
                if (document.getElementById('documento').value != 'Não informado') {
                    let t = 'Ref.: ' + $('#op_nf_tipo :selected').text() + ' Número: ' + operacao.nf.op_nf_numero + ' Série: ' + operacao.nf.op_nf_serie + ".";
                    if (!document.getElementById('op_obs').value.includes(t)) {
                        document.getElementById('op_obs').value = '';
                    }
                }
            }

            document.getElementById('op_obs').focus();

            $('#lista_dctos_fiscais').modal('hide');
            $('#modal_delete_dcto').modal('hide');
        }
    }    

    function valorOutrasOperacoes(id, vlr) {

        if (isNaN(vlr.replaceAll('.', '').replaceAll(',', '.') * 1)) {
            alert('O valor: ' + vlr + ' não é número. Digite um número separado por vírgula no decimal.');
            document.getElementById(id).value = (0).toFixed(2);
            document.getElementById(id).focus();
            return;
        }

        operacao.totais.op_totais_valor_outras_operacoes = convertDoubleString(vlr);
        operacao.totais.op_totais_total_op = convertDoubleString(vlr);
        decimal(id, convertDoubleString(vlr), '2', true)
        decimal('totais', convertDoubleString(vlr), '2', false)
        decimal('op_totais_valor_outras_operacoes_totais', convertDoubleString(vlr), '2', false)
        decimal('op_totais_total_op', convertDoubleString(vlr), '2', false)
    }

    function gravar_op(contexto) {
        let t = '';

        //Gerando dados da operação
        operacao.operacao.op_categoria_id = document.getElementById('op_categoria_id').value;
        let op_data = moment(document.getElementById('op_data').value, 'DD/MM/YYYY', 'pt', true);
        if (op_data.isValid()) {
            operacao.operacao.op_data = op_data.format('DD/MM/YYYY');
        } else {
            t += 'Data operação é inválida;';
        }
        operacao.operacao.op_obs = document.getElementById('op_obs').value;
        //parcelas
        let op_totais_total_op = convertStringDouble(operacao.totais.op_totais_total_op);

        if (operacao.parcelas.length > 0) {
            operacao.operacao.possui_parcelas = true;

            //parcelas - verificando se total parcelas bate com total da operação
            let valor_bruto = 0;
            let total_retencoes = 0;
            for (let i = 0; i < operacao.parcelas.length; i++) {
                valor_bruto += convertStringDouble(operacao.parcelas[i].op_parcela_valor_bruto);
                total_retencoes += convertStringDouble(operacao.parcelas[i].op_parcela_ret_inss);
                total_retencoes += convertStringDouble(operacao.parcelas[i].op_parcela_ret_irrf);
                total_retencoes += convertStringDouble(operacao.parcelas[i].op_parcela_ret_issqn);
                total_retencoes += convertStringDouble(operacao.parcelas[i].op_parcela_ret_pis);
                total_retencoes += convertStringDouble(operacao.parcelas[i].op_parcela_ret_cofins);
                total_retencoes += convertStringDouble(operacao.parcelas[i].op_parcela_ret_csll);
            }

            if (convertStringDouble(op_totais_total_op.toFixed(2)) != convertStringDouble(valor_bruto.toFixed(2))) {
                t += 'Total bruto das parcelas difere do total da operação;';
            }

            //Comparando total retenções informada na parcela com as retençções em operacao.retencoers
            let rp = convertStringDouble(operacao.retencoes.op_ret_inss) + convertStringDouble(operacao.retencoes.op_ret_irrf) + convertStringDouble(operacao.retencoes.op_ret_issqn) + convertStringDouble(operacao.retencoes.op_ret_pis) + convertStringDouble(operacao.retencoes.op_ret_cofins) + convertStringDouble(operacao.retencoes.op_ret_csll);
            if (parseFloat(total_retencoes.toFixed(2)) != parseFloat(rp.toFixed(2))) {
                t += 'Total das retenções nas parcelas difere do todas das retenções;';
            }
        } else {
            operacao.operacao.possui_parcelas = true;
            t += 'Obrigatório informar ao menos uma parcela;';
        }       
        
        //Informando sobre total
        if (op_totais_total_op == 0) {
            t += 'Operação sem valor;';
        }
        //Verificando se foi informado participante
        if (operacao.participante.op_part_participante_id == 0) {
            t += 'Obrigatório informar o participante;';
        }
        //Verificando categoria
        let cat = document.getElementById('op_categoria_id').value;
        if (cat == "" || cat == null || cat == '0' || cat == 0) {
            t += 'Origatório informar uma categoria;';
        }
        //Verificando memorando
        let m = document.getElementById('op_obs').value;
        if (m.length < 5) {
            t += 'Origatório informar um memorando com mais de 4 caracteres;';
        }

        //Distrinchando matriz de erros
        let v = t.split(';');

        for (let i = 0; i < v.length; i++) {
            if (v[i] == '') {
                v.splice(i, 1);
            } 
        }

        if (v.length > 0) {
            document.getElementById('op_valid').innerHTML = '';
            for (let i = 0; i < v.length; i++) {
                let msg = '<span class="text-danger">' + v[i] + '</span></br>';
                $('#op_valid').append(msg);               
            }
            
        } else {
            $.ajax({
                url: "/Operacao/" + contexto,
                data: { __RequestVerificationToken: gettoken(), op: operacao },
                type: 'POST',
                dataType: 'json',
                beforeSend: function (XMLHttpRequest) {
                    document.getElementById('staticLabel').innerHTML = "";
                    document.getElementById('staticLabel').innerHTML = 'Nova Operação';
                    document.getElementById('conteudo').innerHTML = "";
                    document.getElementById('conteudo').innerHTML = "<p>Gravando operação, aguarde...</p>";
                    document.getElementById('rodape').innerHTML = "";
                    $('#modal_mensagem').modal('show');
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {                   
                    alert("erro");
                },
                success: function (data, textStatus, XMLHttpRequest) {
                    var results = JSON.parse(data);

                    if (XMLHttpRequest.responseJSON.includes('alterada com sucesso')) {
                        $('#modal_mensagem').modal('hide');
                        document.getElementById('mensagem_retorno_label').innerHTML = "";
                        document.getElementById('mensagem_retorno_label').innerHTML = "Operação";
                        document.getElementById('mensagem_retorno_conteudo').innerHTML = "";
                        document.getElementById('mensagem_retorno_conteudo').innerHTML = "<p>" + XMLHttpRequest.responseJSON + "</p>";
                        document.getElementById('mensagem_retorno_rodape').innerHTML = "";
                        document.getElementById('mensagem_retorno_rodape').innerHTML = '<a class="btn btn-secondary" href="' + document.location.origin + '/Operacao/Index">Fechar</a>';
                        $('#modal_mensagem_retorno').modal('show');

                        return;
                    }


                    if (XMLHttpRequest.responseJSON.includes('cadastrada com sucesso')) {
                        $('#modal_mensagem').modal('hide');
                        $('#modal_mensagem_sucesso').modal('show');

                        return;
                    }

                    if (XMLHttpRequest.responseJSON.includes('Erro')) {
                        $('#modal_mensagem').modal('hide');
                        document.getElementById('mensagem_retorno_label').innerHTML = "";
                        document.getElementById('mensagem_retorno_label').innerHTML = "ERRO";
                        document.getElementById('mensagem_retorno_conteudo').innerHTML = "";
                        document.getElementById('mensagem_retorno_conteudo').innerHTML = "<p>" + XMLHttpRequest.responseJSON + "</p>";
                        document.getElementById('mensagem_retorno_rodape').innerHTML = "";
                        document.getElementById('mensagem_retorno_rodape').innerHTML = '<button type="button" class="btn btn-secondary" data-dismiss="modal">Voltar</button>';
                        $('#modal_mensagem_retorno').modal('show');

                        return;
                    }
                }
            });
        }

    }

    function operacao_edit(contexto, id) {
        if (contexto == 'open') {
            $.ajax({
                url: "/Operacao/Edit",
                data: { id: id },
                type: 'GET',
                dataType: 'json',
                beforeSend: function (XMLHttpRequest) {
                    document.getElementById('staticLabel').innerHTML = "";
                    document.getElementById('staticLabel').innerHTML = 'Alteração Operação';
                    document.getElementById('conteudo').innerHTML = "";
                    document.getElementById('conteudo').innerHTML = "<p>Carregando operação, aguarde...</p>";
                    document.getElementById('rodape').innerHTML = "";
                    $('#modal_mensagem').modal('show');
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert("erro");
                },
                success: function (data, textStatus, XMLHttpRequest) {
                    operacao = JSON.parse(data);                    

                    if (textStatus != 'success') {
                        document.getElementById('conteudo').innerHTML = "<p>Houve um erro no carregamento da operação. Tente novamente!</p>";
                        document.getElementById('rodape').innerHTML = '<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>';
                        return;
                    }

                    if (textStatus == 'success') {
                        if (operacao != null) {
                            ajustatOperacao();
                            carregaEdit_operacao();


                            $('#modal_mensagem').modal('hide');

                            //Abre modal
                            modal_sobre_modal_open('modal_op_edit');
                        } else {
                            document.getElementById('conteudo').innerHTML = '<p class="text-danger">Erro ao processar a solicitação. Tente novamente!</p>';
                            document.getElementById('rodape').innerHTML = '<button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>';
                            modal_sobre_modal_open('modal_mensagem');
                        }
                        
                    }
                }
            });
        }
    }    

    function carregaEdit_operacao() {

        //Mensagem de verificação baixas fatura e fechamento cartão de crédito
        //==> Limpaando mensagem_operação
        document.getElementById('sub').disabled = false;
        document.getElementById('mensagem_operacao').innerHTML = '';
        document.getElementById('mensagem_operacao').style.display = 'none';
        //==> Executando verificação
        if (document.getElementById('mensagem_operacao') && operacao.mensagem != null) {
            if (operacao.mensagem.length > 0) {
                document.getElementById('sub').disabled = true;
                document.getElementById('mensagem_operacao').innerHTML = operacao.mensagem;
                document.getElementById('mensagem_operacao').style.display = 'block';                
            } else {
                document.getElementById('sub').disabled = false;
                document.getElementById('mensagem_operacao').innerHTML = '';
                document.getElementById('mensagem_operacao').style.display = 'none';                
            }
        }
        //operacaop
        document.getElementById('op_data').value = operacao.operacao.op_data;
        document.getElementById('op_obs').value = operacao.operacao.op_obs;
        if (operacao.parcelas.length > 0) {
            operacao.operacao.possui_parcelas = true;
        }
        //tipo op        
        $('#op_tipo').val(operacao.operacao.op_tipo);        
        $('#op_tipo').trigger('change');
        //participante
        if (operacao.participante.op_part_participante_id > 0) {
            document.getElementById('participante').value = operacao.participante.op_part_nome;
        } else {
            document.getElementById('participante').value = 'Não Informado';
        }
        //Categoria
        GerarCategorias(operacao.operacao.op_tipo, 'op_categoria_id');
        //Contexto de valores        
        let vlr = document.getElementById('op_tipo').value;
        if (vlr == 'Compra' || vlr == 'Venda') { //Compra/Venda Produtos
            document.getElementById('itens_operacao').style.display = 'block';
            document.getElementById('servico_operacao').style.display = 'none';
            document.getElementById('outros_operacao').style.display = 'none';

            document.getElementById('totais_servico').style.display = 'none';
            document.getElementById('totais_itens').style.display = 'block';
            document.getElementById('totais_demais').style.display = 'none';

            if (operacao.itens.length > 0) {
                document.getElementById('itens').value = 'Quantidade de Itens Informado: ' + operacao.itens.length;
            } else {
                document.getElementById('itens').value = 'Não informado';
            }

        }
        if (vlr == 'ServicoPrestado' || vlr == 'ServicoTomado') { //Serviços
            document.getElementById('itens_operacao').style.display = 'none';
            document.getElementById('servico_operacao').style.display = 'block';
            document.getElementById('outros_operacao').style.display = 'none';

            document.getElementById('totais_servico').style.display = 'block';
            document.getElementById('totais_itens').style.display = 'none';
            document.getElementById('totais_demais').style.display = 'none';

            if (convertStringDouble(operacao.totais.op_totais_preco_servicos) > 0) {
                document.getElementById('servicos').value = 'Valor do Serviço Informado: ' + operacao.servico.op_servico_valor.toLocaleString("pt-BR", { style: "decimal", minimumFractionDigits: "2", maximumFractionDigits: "6" });

            } else {
                document.getElementById('servicos').value = 'Não informado';
            }
        }
        if (vlr == 'OutrasDespesas' || vlr == 'OutrasReceitas') {//Outros
            document.getElementById('itens_operacao').style.display = 'none';
            document.getElementById('servico_operacao').style.display = 'none';
            document.getElementById('outros_operacao').style.display = 'block';

            document.getElementById('totais_servico').style.display = 'none';
            document.getElementById('totais_itens').style.display = 'none';
            document.getElementById('totais_demais').style.display = 'block';

            document.getElementById('op_totais_valor_outras_operacoes').value = operacao.totais.op_totais_valor_outras_operacoes;
        }

        let txt = '';
        let soma = 0;

        if (operacao.operacao.op_comRetencoes) {
            if (convertStringDouble(operacao.retencoes.op_ret_inss) > 0) {
                txt += 'INSS: ' + operacao.retencoes.op_ret_inss + ' ';
                soma += convertStringDouble(operacao.retencoes.op_ret_inss);
            }
            if (convertStringDouble(operacao.retencoes.op_ret_issqn) > 0) {
                txt += 'ISSQN: ' + operacao.retencoes.op_ret_issqn + ' ';
                soma += convertStringDouble(operacao.retencoes.op_ret_issqn);
            }
            if (convertStringDouble(operacao.retencoes.op_ret_irrf) > 0) {
                txt += 'IRRF: ' + operacao.retencoes.op_ret_irrf + ' ';
                soma += convertStringDouble(operacao.retencoes.op_ret_irrf);
            }
            if (convertStringDouble(operacao.retencoes.op_ret_pis) > 0) {
                txt += 'PIS: ' + operacao.retencoes.op_ret_pis + ' ';
                soma += convertStringDouble(operacao.retencoes.op_ret_pis);
            }
            if (convertStringDouble(operacao.retencoes.op_ret_cofins) > 0) {
                txt += 'COFINS: ' + operacao.retencoes.op_ret_cofins + ' ';
                soma += convertStringDouble(operacao.retencoes.op_ret_cofins);
            }
            if (convertStringDouble(operacao.retencoes.op_ret_csll) > 0) {
                txt += 'CSLL: ' + operacao.retencoes.op_ret_csll + ' ';
                soma += convertStringDouble(operacao.retencoes.op_ret_csll);
            }            
        } 
        if (soma > 0) {
            document.getElementById('retencoes').value = txt;
        } else {
            document.getElementById('retencoes').value = 'Não informado';
        }

        if (operacao.parcelas.length > 0) {
            let soma = 0;
            for (let i = 0; i < operacao.parcelas.length; i++) {
                soma += convertStringDouble(operacao.parcelas[i].op_parcela_valor);
            }

            document.getElementById('parcelas').value = 'Número Parcelas: ' + operacao.parcelas.length + ' Valor Líquido: ' + convertDoubleString(soma);
        } else {
            document.getElementById('parcelas').value = 'Não informado';
        }
        //notas 
        if (operacao.operacao.op_comNF > 0) {
            document.getElementById('documento').value = 'Número: ' + operacao.nf.op_nf_numero + ' Série: ' + operacao.nf.op_nf_serie;
        } else {
            document.getElementById('documento').value = 'Não informado';
        } 
        //totais
        document.getElementById('totais').value = operacao.totais.op_totais_total_op;
        document.getElementById('op_totais_preco_itens').value = operacao.totais.op_totais_preco_itens;
        document.getElementById('op_totais_frete').value = operacao.totais.op_totais_frete;
        document.getElementById('op_totais_seguro').value = operacao.totais.op_totais_seguro;
        document.getElementById('op_totais_desp_aces').value = operacao.totais.op_totais_desp_aces;
        document.getElementById('op_totais_desconto').value = operacao.totais.op_totais_desconto;
        document.getElementById('op_totais_icms_st').value = operacao.totais.op_totais_icms_st;
        document.getElementById('op_totais_ipi').value = operacao.totais.op_totais_ipi;
        document.getElementById('op_totais_total_op').value = operacao.totais.op_totais_total_op;
        document.getElementById('op_totais_valor_outras_operacoes_totais').value = operacao.totais.op_totais_valor_outras_operacoes;
        document.getElementById('op_totais_preco_servicos').value = operacao.totais.op_totais_preco_servicos;

        //Produzindo selects categoria e forma de pagamento contextualizada ao tipo op.
        GerarFormaPgto(vlr, 'op_parcela_fp_id');
        GerarFormaPgto(vlr, 'op_parcela_fp_id_edit');
        
    }

    function ajustatOperacao() {
        //operação.operação
        operacao.operacao.op_data = convertData_DataSimples(operacao.operacao.op_data);
        operacao.operacao.op_dataCriacao = convertData_DataSimples(operacao.operacao.op_dataCriacao);
        operacao.operacao.op_data_saida = convertData_DataSimples(operacao.operacao.op_data_saida);
        operacao.operacao.op_previsao_entrega = convertData_DataSimples(operacao.operacao.op_previsao_entrega);
        //Totais
        operacao.retencoes.op_ret_cofins = convertDoubleString(operacao.retencoes.op_ret_cofins);
        operacao.retencoes.op_ret_csll = convertDoubleString(operacao.retencoes.op_ret_csll);
        operacao.retencoes.op_ret_inss = convertDoubleString(operacao.retencoes.op_ret_inss);
        operacao.retencoes.op_ret_irrf = convertDoubleString(operacao.retencoes.op_ret_irrf);
        operacao.retencoes.op_ret_issqn = convertDoubleString(operacao.retencoes.op_ret_issqn);
        operacao.retencoes.op_ret_pis = convertDoubleString(operacao.retencoes.op_ret_pis);

        //Totais
        operacao.totais.op_totais_desconto = convertDoubleString(operacao.totais.op_totais_desconto);
        operacao.totais.op_totais_desp_aces = convertDoubleString(operacao.totais.op_totais_desp_aces);
        operacao.totais.op_totais_frete = convertDoubleString(operacao.totais.op_totais_frete);
        operacao.totais.op_totais_icms_st = convertDoubleString(operacao.totais.op_totais_icms_st);
        operacao.totais.op_totais_ipi = convertDoubleString(operacao.totais.op_totais_ipi);
        operacao.totais.op_totais_preco_itens = convertDoubleString(operacao.totais.op_totais_preco_itens);
        operacao.totais.op_totais_preco_servicos = convertDoubleString(operacao.totais.op_totais_preco_servicos);
        operacao.totais.op_totais_qtd_itens = convertDoubleString(operacao.totais.op_totais_qtd_itens);
        operacao.totais.op_totais_retencoes = convertDoubleString(operacao.totais.op_totais_retencoes);
        operacao.totais.op_totais_saldoLiquidacao = convertDoubleString(operacao.totais.op_totais_saldoLiquidacao);
        operacao.totais.op_totais_seguro = convertDoubleString(operacao.totais.op_totais_seguro);
        operacao.totais.op_totais_total_op = convertDoubleString(operacao.totais.op_totais_total_op);
        operacao.totais.op_totais_valor_outras_operacoes = convertDoubleString(operacao.totais.op_totais_valor_outras_operacoes);
        //Parcelas
        for (let i = 0; i < operacao.parcelas.length; i++) {
            operacao.parcelas[i].op_parcela_vencimento = convertData_DataSimples(operacao.parcelas[i].op_parcela_vencimento);
            operacao.parcelas[i].op_parcela_ret_cofins = convertDoubleString(operacao.parcelas[i].op_parcela_ret_cofins);
            operacao.parcelas[i].op_parcela_ret_csll = convertDoubleString(operacao.parcelas[i].op_parcela_ret_csll);
            operacao.parcelas[i].op_parcela_ret_inss = convertDoubleString(operacao.parcelas[i].op_parcela_ret_inss);
            operacao.parcelas[i].op_parcela_ret_irrf = convertDoubleString(operacao.parcelas[i].op_parcela_ret_irrf);
            operacao.parcelas[i].op_parcela_ret_issqn = convertDoubleString(operacao.parcelas[i].op_parcela_ret_issqn);
            operacao.parcelas[i].op_parcela_ret_pis = convertDoubleString(operacao.parcelas[i].op_parcela_ret_pis);
            operacao.parcelas[i].op_parcela_saldo = convertDoubleString(operacao.parcelas[i].op_parcela_saldo);
            operacao.parcelas[i].op_parcela_valor = convertDoubleString(operacao.parcelas[i].op_parcela_valor);
            operacao.parcelas[i].op_parcela_valor_bruto = convertDoubleString(operacao.parcelas[i].op_parcela_valor_bruto);
            operacao.parcelas[i].baixas = convertDoubleString(operacao.parcelas[i].baixas);
        }
        //Serviços
        operacao.servico.op_servico_valor = convertDoubleString(operacao.servico.op_servico_valor);
        //Itens
        for (let i = 0; i < operacao.itens.length; i++) {            
            operacao.itens[i].op_item_desconto = convertDoubleString(operacao.itens[i].op_item_desconto);
            operacao.itens[i].op_item_desp_aces = convertDoubleString(operacao.itens[i].op_item_desp_aces);
            operacao.itens[i].op_item_frete = convertDoubleString(operacao.itens[i].op_item_frete);
            operacao.itens[i].op_item_preco = convertDoubleString(operacao.itens[i].op_item_preco);
            operacao.itens[i].op_item_seguros = convertDoubleString(operacao.itens[i].op_item_seguros);
            operacao.itens[i].op_item_valor_total = convertDoubleString(operacao.itens[i].op_item_valor_total);
            operacao.itens[i].op_item_vlr_icms_st = convertDoubleString(operacao.itens[i].op_item_vlr_icms_st);
            operacao.itens[i].op_item_vlr_ipi = convertDoubleString(operacao.itens[i].op_item_vlr_ipi);
        }
        //documento fiscal
        operacao.nf.op_nf_data_emissao = convertData_DataSimples(operacao.nf.op_nf_data_emissao);
        operacao.nf.op_nf_data_entrada_saida = convertData_DataSimples(operacao.nf.op_nf_data_entrada_saida);
    }

    async function myFunction() {
        return "Hello";
    }

    function GerarCategorias(op_tipo, select_id) {
        $.ajax({
            url: "/Operacao/GerarCategorias",
            data: { __RequestVerificationToken: gettoken(), op_tipo: op_tipo },
            type: 'POST',
            dataType: 'json',
            beforeSend: function (XMLHttpRequest) {
                if (document.getElementById('text_categorias')) {
                    document.getElementById('text_categorias').innerHTML = "Gerando categorias...";
                    if (document.getElementById('sub')) {
                        document.getElementById('sub').setAttribute("disabled", "disabled");
                    }
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("erro");
            },
            success: function (data, textStatus, XMLHttpRequest) {
                var results = JSON.parse(data);
                $('#' + select_id).children('option').remove(); //Remove todos os itens do select

                for (i = 0; i < results.length; i++) { //Adiciona os item recebidos no results no select
                    $('#' + select_id).append($("<option></option>").attr("value", results[i].value).text(results[i].text));
                }

                if (document.getElementById('op_categoria_id')) {
                    if (operacao.operacao.op_categoria_id != 0) {
                        $('#op_categoria_id').val(operacao.operacao.op_categoria_id);
                        $('#op_categoria_id').trigger('change');
                    }                    
                }

                if (document.getElementById('text_categorias')) {
                    document.getElementById('text_categorias').innerHTML = "";
                    if (document.getElementById('sub')) {
                        document.getElementById('sub').removeAttribute("disabled");
                    }
                }
            }
        });
    }

    function dadosFormaPgto(id, vlr) {
        $.ajax({
            url: "/FormaPagamento/getFormaPagamento",
            data: { __RequestVerificationToken: gettoken(), fp_id: vlr },
            type: 'POST',
            dataType: 'json',
            beforeSend: function (XMLHttpRequest) {
                if (document.getElementById('btn_op_parcelas_gerar')) {
                    document.getElementById('btn_op_parcelas_gerar').setAttribute("disabled", "disabled");
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("erro");
            },
            success: function (data, textStatus, XMLHttpRequest) {
                var results = JSON.parse(data);                
                if (textStatus == 'success') {
                    if (results.fp_meio_pgto_nfe == '03') {
                        if (document.getElementById('btn_op_parcelas_gerar')) {
                            document.getElementById('btn_op_parcelas_gerar').removeAttribute("disabled");
                        }
                        document.getElementById('parcela_forma_gerar').value = 3;
                        document.getElementById('data_primeira_parcela').value = document.getElementById('op_data').value;
                        document.getElementById('recorencia_n_parcelas').value = 'Mensal';
                        document.getElementById('parcela_forma_gerar').setAttribute("disabled", "disabled");
                        document.getElementById('data_primeira_parcela').setAttribute("disabled", "disabled");
                        document.getElementById('recorencia_n_parcelas').setAttribute("disabled", "disabled");
                        formaGerarParcelas('parcela_forma_gerar', 3);
                        document.getElementById('parcela_numero').focus();
                    } else {
                        document.getElementById('parcela_forma_gerar').value = 1;
                        document.getElementById('data_primeira_parcela').value = '';
                        document.getElementById('recorencia_n_parcelas').value = 'Mensal';
                        document.getElementById('parcela_forma_gerar').removeAttribute("disabled");
                        document.getElementById('data_primeira_parcela').removeAttribute("disabled");
                        document.getElementById('recorencia_n_parcelas').removeAttribute("disabled");
                        formaGerarParcelas('parcela_forma_gerar', 1);
                        document.getElementById('parcela_forma_gerar').focus();
                    }
                }

                if (document.getElementById('btn_op_parcelas_gerar')) {
                    document.getElementById('btn_op_parcelas_gerar').removeAttribute("disabled");
                }
            }
        });
    }    
</script>